<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheelz AI - Buy Vehicles</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <!-- Removed external buy.css as Tailwind is used and custom styles are embedded -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght%40400%3B500%3B700%3B900&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* Custom styles to match the provided design */
        body {
            font-family: 'Inter', sans-serif; /* Primary font */
            background-color: #1a202c; /* Dark background color */
            color: #e2e8f0; /* Light text color */
        }
        .design-root {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure it takes full viewport height */
        }
        .layout-container {
            display: flex;
            flex-direction: column;
            flex: 1; /* Allows content to grow */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2.5rem; /* px-10 */
            background-color: #2d3748; /* Darker header background */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .header-brand .logo img {
            height: 40px; /* Adjust logo size */
            width: auto;
        }
        .header-brand h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #e2e8f0;
        }
        .header-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .nav-links a {
            color: #a0aec0; /* text-gray-400 */
            font-size: 1rem;
            font-weight: 500;
            margin-left: 1rem;
            transition: color 0.2s ease-in-out;
        }
        .nav-links a:hover {
            color: #e2e8f0; /* text-white */
        }
        .sign-in-btn {
            background-color: #4299e1; /* Blue-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .sign-in-btn:hover {
            background-color: #3182ce; /* Blue-600 */
        }
        .sign-in-btn a {
            color: inherit;
            text-decoration: none;
        }

        /* Main content container adjustments */
        .layout-content-container {
            background-color: #2b3540; /* Match search bar background */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 20px;
            margin-top: 20px;
        }
        .section-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e2e8f0; /* Light text color */
            text-align: center;
        }

        /* Vehicle Grid and Card styles */
        .dynamic-vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted min-width for better fit */
            gap: 20px;
            padding: 1rem; /* p-4 from original markup */
        }
        .vehicle-card {
            background-color: #1a202c; /* Darker card background */
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #4a5568; /* Subtle border */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        .vehicle-card h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }
        .vehicle-card p {
            font-size: 0.875rem; /* text-sm */
            color: #a0aec0;
            margin-bottom: 0.25rem;
        }
        .vehicle-card p strong {
            color: #e2e8f0;
        }
        .vehicle-card .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center; /* Center images if few */
        }
        .vehicle-card .image-gallery img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.25rem;
            border: 1px solid #4a5568;
        }
        .vehicle-card .contact-info {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #4a5568;
        }
        .vehicle-card .contact-info p {
            font-size: 0.8rem;
            color: #a0aec0;
        }
        .vehicle-card .timestamp {
            font-size: 0.7rem;
            color: #718096;
            margin-top: 0.75rem;
            text-align: right;
        }

        /* Dropdown styles */
        .dropdown-menu {
            max-height: 200px; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling */
        }
        .dropdown-menu a {
            padding: 8px 16px;
            display: block;
            color: white;
            text-decoration: none;
        }
        .dropdown-menu a:hover {
            background-color: #3a4756;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 1rem;
            }
            .header-nav {
                margin-top: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            .nav-links {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .nav-links a {
                margin-left: 0;
            }
            .px-40 {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .layout-content-container {
                padding: 10px;
            }
            .dynamic-vehicle-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
        }
    </style>
</head>
<body>
    <div class="design-root">
        <div class="layout-container">
            <header class="header">
                <div class="header-brand">
                    <div class="logo">
                        <img src="https://placehold.co/40x40/000000/FFFFFF?text=Logo" alt="WheelzAI Logo">
                    </div>
                    <h2>WheelzAI</h2>
                </div>
                <div class="header-nav">
                    <div class="nav-links">
                        <a href="home.html">Home</a>
                        <a href="buy.html">Buy</a>
                        <a href="about.html">About</a>
                        <a href="contact.html">Contact Us</a>
                    </div>
                    <button class="sign-in-btn">
                        <a href="signin.html">Logout</a>
                    </button>
                </div>
            </header>
            <div class="px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                    <div class="px-4 py-3">
                        <label class="flex flex-col min-w-40 h-12 w-full">
                            <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                                <div
                                    class="text-[#9eacbd] flex border-none bg-[#2b3540] items-center justify-center pl-4 rounded-l-xl border-r-0"
                                    data-icon="MagnifyingGlass"
                                    data-size="24px"
                                    data-weight="regular"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                        <path
                                            d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"
                                        ></path>
                                    </svg>
                                </div>
                                <input
                                    id="searchInput"
                                    placeholder="Search for make, model, or keyword"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border-none bg-[#2b3540] focus:border-none h-full placeholder:text-[#9eacbd] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                                    value=""
                                />
                            </div>
                        </label>
                    </div>
                    <div class="flex gap-3 p-3 flex-wrap pr-4">
                        <div class="relative">
                            <button id="brandFilterBtn" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#2b3540] pl-4 pr-4 cursor-pointer">
                                <p class="text-white text-sm font-medium leading-normal">Brand</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,45.66,90.34L128,172.69l82.34-82.35A8,8,0,0,1,213.66,101.66Z"></path>
                                </svg>
                            </button>
                            <div id="brandDropdown" class="absolute z-10 mt-2 w-48 rounded-md shadow-lg bg-[#2b3540] ring-1 ring-black ring-opacity-5 hidden dropdown-menu">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="brandFilterBtn">
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="All">All Brands</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Toyota">Toyota</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Honda">Honda</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Nissan">Nissan</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Mitsubishi">Mitsubishi</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Mercedes-Benz">Mercedes-Benz</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="BMW">BMW</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Audi">Audi</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Ford">Ford</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Hyundai">Hyundai</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Kia">Kia</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Mahindra">Mahindra</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Tata">Tata</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="Bajaj">Bajaj</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="brand" data-filter-value="TVS">TVS</a>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="vehicleTypeFilterBtn" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#2b3540] pl-4 pr-4 cursor-pointer">
                                <p class="text-white text-sm font-medium leading-normal">Vehicle Type</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,45.66,90.34L128,172.69l82.34-82.35A8,8,0,0,1,213.66,101.66Z"></path>
                                </svg>
                            </button>
                            <div id="vehicleTypeDropdown" class="absolute z-10 mt-2 w-48 rounded-md shadow-lg bg-[#2b3540] ring-1 ring-black ring-opacity-5 hidden dropdown-menu">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="vehicleTypeFilterBtn">
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="All">All Types</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Car">Car</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Motorcycle">Motorcycle</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Van">Van</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Bus">Bus</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Lorry">Lorry</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Three Wheel">Three Wheel</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Tractor">Tractor</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="vehicleType" data-filter-value="Heavy Duty">Heavy Duty</a>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="priceRangeFilterBtn" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#2b3540] pl-4 pr-4 cursor-pointer">
                                <p class="text-white text-sm font-medium leading-normal">Price Range</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,45.66,90.34L128,172.69l82.34-82.35A8,8,0,0,1,213.66,101.66Z"></path>
                                </svg>
                            </button>
                            <div id="priceRangeDropdown" class="absolute z-10 mt-2 w-60 rounded-md shadow-lg bg-[#2b3540] ring-1 ring-black ring-opacity-5 hidden dropdown-menu">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="priceRangeFilterBtn">
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="All">All Prices</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="0-1000000">Under Rs. 1,000,000</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="1000000-3000000">Rs. 1,000,000 - Rs. 3,000,000</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="3000000-5000000">Rs. 3,000,000 - Rs. 5,000,000</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="5000000-10000000">Rs. 5,000,000 - Rs. 10,000,000</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="10000000-20000000">Rs. 10,000,000 - Rs. 20,000,000</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-white hover:bg-[#3a4756] filter-option" data-filter-type="priceRange" data-filter-value="20000000-">Over Rs. 20,000,000</a>
                                </div>
                            </div>
                        </div>
                        <button id="clearFiltersBtn" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-red-600 pl-4 pr-4 cursor-pointer">
                            <p class="text-white text-sm font-medium leading-normal">Clear Filters</p>
                        </button>
                    </div>
                    <div id="dynamicVehiclesGrid" class="dynamic-vehicle-grid">
                        <p class="text-gray-500 text-center col-span-full" id="loadingVehicles">Loading vehicles...</p>
                        </div>
                </div>
            </div>
        </div>
        <footer class="flex justify-center">
            <div class="flex max-w-[960px] flex-1 flex-col">
              <footer class="flex flex-col gap-6 px-5 py-10 text-center @container">
                <div
                  class="flex flex-wrap items-center justify-center gap-6 @[480px]:flex-row @[480px]:justify-around"
                >
                  <a class="text-[#93acc8] text-base font-normal leading-normal min-w-40" href="#">Home</a>
                  <a class="text-[#93acc8] text-base font-normal leading-normal min-w-40" href="#">Buy</a>
                  <a class="text-[#93acc8] text-base font-normal leading-normal min-w-40" href="#">About</a>
                  <a class="text-[#93acc8] text-base font-normal leading-normal min-w-40" href="#">Contact Us</a>
                  <a class="text-[#93acc8] text-base font-normal leading-normal min-w-40" href="#"
                    >516/4, Dutugamunu road, Kohuwala</a
                  >
                </div>
                <div class="flex flex-wrap justify-center gap-4">
                  <a href="#">
                    <div class="text-[#93acc8]" data-icon="InstagramLogo" data-size="24px" data-weight="regular">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                        <path
                          d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160ZM176,24H80A56.06,56.06,0,0,0,24,80v96a56.06,56.06,0,0,0,56,56h96a56.06,56.06,0,0,0,56-56V80A56.06,56.06,0,0,0,176,24Zm40,152a40,40,0,0,1-40,40H80a40,40,0,0,1-40-40V80A40,40,0,0,1,80,40h96a40,40,0,0,1,40,40ZM192,76a12,12,0,1,1-12-12A12,12,0,0,1,192,76Z"
                        ></path>
                      </svg>
                    </div>
                  </a>
                  <a href="#">
                    <div class="text-[#93acc8]" data-icon="TiktokLogo" data-size="24px" data-weight="regular">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                        <path
                          d="M224,72a48.05,48.05,0,0,1-48-48,8,8,0,0,0-8-8H128a8,8,0,0,0-8,8V156a20,20,0,1,1-28.57-18.08A8,8,0,0,0,96,130.69V88a8,8,0,0,0-9.4-7.88C50.91,86.48,24,119.1,24,156a76,76,0,0,0,152,0V116.29A103.25,103.25,0,0,0,224,128a8,8,0,0,0,8-8V80A8,8,0,0,0,224,72Zm-8,39.64a87.19,87.19,0,0,1-43.33-16.15A8,8,0,0,0,160,102v54a60,60,0,0,1-120,0c0-25.9,16.64-49.13,40-57.6v27.67A36,36,0,1,0,136,156V32h24.5A64.14,64.14,0,0,0,216,87.5Z"
                        ></path>
                      </svg>
                    </div>
                  </a>
                </div>
                <p class="text-[#93acc8] text-base font-normal leading-normal">Â© 2025 WheelzAI. All rights reserved.</p>
              </footer>
            </div>
        </footer>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAOamMqCPIzJurf85fjBleVmWffdscEslM",
            authDomain: "wheelzai.firebaseapp.com",
            projectId: "wheelzai",
            storageBucket: "wheelzai.firebasestorage.app",
            messagingSenderId: "132756052907",
            appId: "1:132756052907:web:b92dc998b4b5bee8d450ee",
            measurementId: "G-ECQJYZYK43"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let allVehicles = []; // Store all fetched vehicles for filtering
        let currentFilters = {
            searchQuery: '',
            brand: 'All',
            vehicleType: 'All',
            priceRange: 'All'
        };

        // DOM elements (moved inside DOMContentLoaded for safer access)
        let dynamicVehiclesGrid;
        let loadingVehicles;
        let searchInput;
        let brandFilterBtn;
        let brandDropdown;
        let vehicleTypeFilterBtn;
        let vehicleTypeDropdown;
        let priceRangeFilterBtn;
        let priceRangeDropdown;
        let clearFiltersBtn; // New: Clear Filters button


        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase services initialized: app, db, auth.");

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log('Signed in with custom token.');
                } else {
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously.');
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Auth state changed. User ID:', userId);
                        setupRealtimeListener();
                    } else {
                        signInAnonymously(auth).then(anonUser => {
                            userId = anonUser.user.uid;
                            console.log('Auth state changed. Signed in anonymously. User ID:', userId);
                            setupRealtimeListener();
                        }).catch(error => {
                            console.error("Error signing in anonymously:", error);
                        });
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
            }
        }

        /**
         * Sets up a real-time listener for vehicle data from Firestore.
         */
        function setupRealtimeListener() {
            if (!db || !userId) {
                console.warn("Firestore or User ID not ready for real-time listener.");
                return;
            }
            const vehiclesCollectionRef = collection(db, `artifacts/${appId}/public/data/vehicles`);
            const q = query(vehiclesCollectionRef);

            onSnapshot(q, (snapshot) => {
                loadingVehicles.style.display = 'none';
                allVehicles = []; // Clear previous data
                snapshot.forEach((doc) => {
                    allVehicles.push({ id: doc.id, ...doc.data() });
                });
                applyFiltersAndRenderVehicles(); // Render vehicles after fetching
            }, (error) => {
                console.error("Error listening to vehicles collection:", error);
                dynamicVehiclesGrid.innerHTML = '<p class="text-red-500 text-center col-span-full">Failed to load vehicles.</p>';
                loadingVehicles.style.display = 'none';
            });
        }

        /**
         * Renders the vehicles based on the current filters.
         */
        function applyFiltersAndRenderVehicles() {
            dynamicVehiclesGrid.innerHTML = ''; // Clear existing vehicles

            let filteredVehicles = allVehicles;

            // Apply search query filter
            if (currentFilters.searchQuery) {
                const query = currentFilters.searchQuery.toLowerCase();
                filteredVehicles = filteredVehicles.filter(vehicle =>
                    (vehicle.vehicleMake && vehicle.vehicleMake.toLowerCase().includes(query)) ||
                    (vehicle.model && vehicle.model.toLowerCase().includes(query)) ||
                    (vehicle.additionalInfo && vehicle.additionalInfo.toLowerCase().includes(query))
                );
            }

            // Apply brand filter
            if (currentFilters.brand !== 'All') {
                filteredVehicles = filteredVehicles.filter(vehicle =>
                    vehicle.vehicleMake === currentFilters.brand
                );
            }

            // Apply vehicle type filter
            if (currentFilters.vehicleType !== 'All') {
                filteredVehicles = filteredVehicles.filter(vehicle =>
                    vehicle.vehicleType === currentFilters.vehicleType
                );
            }

            // Apply price range filter
            if (currentFilters.priceRange !== 'All') {
                const [minPrice, maxPrice] = currentFilters.priceRange.split('-').map(Number);
                filteredVehicles = filteredVehicles.filter(vehicle => {
                    const price = vehicle.price;
                    if (price === undefined || price === null) return false; // Exclude vehicles without a price
                    
                    if (isNaN(maxPrice)) { // Case for "Over X" (e.g., "20000000-")
                        return price >= minPrice;
                    } else { // Case for "X - Y" (e.g., "1000000-3000000")
                        return price >= minPrice && price <= maxPrice;
                    }
                });
            }


            if (filteredVehicles.length === 0) {
                dynamicVehiclesGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full">No vehicles match your criteria.</p>';
                return;
            }

            filteredVehicles.forEach((vehicle) => {
                const vehicleCard = document.createElement('div');
                vehicleCard.className = 'vehicle-card';
                
                const options = [];
                if (vehicle.airCondition) options.push("Air Condition");
                if (vehicle.powerSteering) options.push("Power Steering");
                if (vehicle.powerMirror) options.push("Power Mirror");
                if (vehicle.powerWindow) options.push("Power Window");
                const optionsText = options.length > 0 ? options.join(', ') : 'None';

                const timestamp = vehicle.timestamp ? new Date(vehicle.timestamp.toDate()).toLocaleString() : 'N/A';

                let imageGalleryHtml = '';
                const imageUrls = [
                    vehicle.mainImageUrl,
                    vehicle.image2Url,
                    vehicle.image3Url,
                    vehicle.image4Url,
                    vehicle.image5Url,
                    vehicle.image6Url
                ].filter(url => url);

                if (imageUrls.length > 0) {
                    imageGalleryHtml = `<div class="image-gallery">`;
                    imageUrls.forEach(url => {
                        imageGalleryHtml += `<img src="${url}" alt="Vehicle Image" onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/ffffff?text=No+Image';">`;
                    });
                    imageGalleryHtml += `</div>`;
                } else {
                    imageGalleryHtml = `<p class="text-gray-500 text-sm">No images available</p>`;
                }

                vehicleCard.innerHTML = `
                    <h3>${vehicle.vehicleMake || 'N/A'} ${vehicle.model || 'N/A'} (${vehicle.manufacturedYear || 'N/A'})</h3>
                    <p><strong>Price:</strong> Rs. ${vehicle.price ? vehicle.price.toLocaleString() : 'N/A'}</p>
                    <p><strong>Type:</strong> ${vehicle.vehicleType || 'N/A'} | <strong>Condition:</strong> ${vehicle.vehicleCondition || 'N/A'}</p>
                    <p><strong>Transmission:</strong> ${vehicle.transmission || 'N/A'} | <strong>Fuel:</strong> ${vehicle.fuelType || 'N/A'}</p>
                    <p><strong>Mileage:</strong> ${vehicle.mileage ? vehicle.mileage.toLocaleString() : 'N/A'} km | <strong>Engine:</strong> ${vehicle.engineCapacity || 'N/A'} CC</p>
                    <p><strong>City:</strong> ${vehicle.city || 'N/A'}</p>
                    <p><strong>Options:</strong> ${optionsText}</p>
                    <p><strong>Details:</strong> ${vehicle.additionalInfo || 'N/A'}</p>
                    ${imageGalleryHtml}
                    <div class="contact-info">
                        <p><strong>Seller:</strong> ${vehicle.contactName || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${vehicle.phoneNumber || 'N/A'}</p>
                    </div>
                    <p class="timestamp">Posted on: ${timestamp}</p>
                `;
                dynamicVehiclesGrid.appendChild(vehicleCard);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired for buy.html.");

            // Assign DOM elements here to ensure they are available
            dynamicVehiclesGrid = document.getElementById('dynamicVehiclesGrid');
            loadingVehicles = document.getElementById('loadingVehicles');
            searchInput = document.getElementById('searchInput');
            brandFilterBtn = document.getElementById('brandFilterBtn');
            brandDropdown = document.getElementById('brandDropdown');
            vehicleTypeFilterBtn = document.getElementById('vehicleTypeFilterBtn');
            vehicleTypeDropdown = document.getElementById('vehicleTypeDropdown');
            priceRangeFilterBtn = document.getElementById('priceRangeFilterBtn');
            priceRangeDropdown = document.getElementById('priceRangeDropdown');
            clearFiltersBtn = document.getElementById('clearFiltersBtn'); // Assign Clear Filters button


            // Now attach event listeners
            searchInput.addEventListener('input', () => {
                currentFilters.searchQuery = searchInput.value;
                applyFiltersAndRenderVehicles();
            });

            brandFilterBtn.addEventListener('click', () => {
                brandDropdown.classList.toggle('hidden');
                vehicleTypeDropdown.classList.add('hidden'); // Close other dropdown
                priceRangeDropdown.classList.add('hidden'); // Close other dropdown
            });

            vehicleTypeFilterBtn.addEventListener('click', () => {
                vehicleTypeDropdown.classList.toggle('hidden');
                brandDropdown.classList.add('hidden'); // Close other dropdown
                priceRangeDropdown.classList.add('hidden'); // Close other dropdown
            });

            // Event listener for Price Range filter button
            priceRangeFilterBtn.addEventListener('click', () => {
                priceRangeDropdown.classList.toggle('hidden');
                brandDropdown.classList.add('hidden'); // Close other dropdown
                vehicleTypeDropdown.classList.add('hidden'); // Close other dropdown
            });

            // New: Event listener for Clear Filters button
            clearFiltersBtn.addEventListener('click', () => {
                // Reset currentFilters
                currentFilters = {
                    searchQuery: '',
                    brand: 'All',
                    vehicleType: 'All',
                    priceRange: 'All'
                };

                // Reset search input
                searchInput.value = '';

                // Reset button texts
                brandFilterBtn.querySelector('p').textContent = 'Brand';
                vehicleTypeFilterBtn.querySelector('p').textContent = 'Vehicle Type';
                priceRangeFilterBtn.querySelector('p').textContent = 'Price Range';

                // Hide all dropdowns
                brandDropdown.classList.add('hidden');
                vehicleTypeDropdown.classList.add('hidden');
                priceRangeDropdown.classList.add('hidden');

                // Apply filters to re-render all vehicles
                applyFiltersAndRenderVehicles();
            });


            // Handle clicks outside dropdowns to close them
            document.addEventListener('click', (event) => {
                if (!brandFilterBtn.contains(event.target) && !brandDropdown.contains(event.target)) {
                    brandDropdown.classList.add('hidden');
                }
                if (!vehicleTypeFilterBtn.contains(event.target) && !vehicleTypeDropdown.contains(event.target)) {
                    vehicleTypeDropdown.classList.add('hidden');
                }
                if (!priceRangeFilterBtn.contains(event.target) && !priceRangeDropdown.contains(event.target)) {
                    priceRangeDropdown.classList.add('hidden');
                }
            });

            // Handle filter option clicks
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior
                    const filterType = event.target.dataset.filterType;
                    const filterValue = event.target.dataset.filterValue;

                    currentFilters[filterType] = filterValue;
                    applyFiltersAndRenderVehicles();

                    // Update button text to reflect selected filter
                    if (filterType === 'brand') {
                        brandFilterBtn.querySelector('p').textContent = filterValue === 'All' ? 'Brand' : filterValue;
                        brandDropdown.classList.add('hidden');
                    } else if (filterType === 'vehicleType') {
                        vehicleTypeFilterBtn.querySelector('p').textContent = filterValue === 'All' ? 'Vehicle Type' : filterValue;
                        vehicleTypeDropdown.classList.add('hidden');
                    } else if (filterType === 'priceRange') {
                        // Update button text for price range
                        priceRangeFilterBtn.querySelector('p').textContent = event.target.textContent;
                        priceRangeDropdown.classList.add('hidden');
                    }
                });
            });

            initializeFirebase();
        });
    </script>
</body>
</html>