<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WheelzAI - Customer Dashboard</title>
    <link rel="stylesheet" href="/Wheelz_AI/css/dashboard.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Define global popup functions immediately when page loads
        window.showLogoutPopup = function() {
            // Remove any existing popup
            const existingPopup = document.getElementById('logout-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            const popupHTML = `
                <div id="logout-popup" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease;">
                    <div class="logout-popup-container" style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); transform: scale(0.9); transition: transform 0.3s ease;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(45deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 24px; color: white;">🚪</div>
                        <h3 style="font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">Confirm Logout</h3>
                        <p style="color: #64748b; font-size: 16px; line-height: 1.6; margin-bottom: 24px;">
                            Are you sure you want to logout? You'll need to sign in again to access your account.
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.hideLogoutPopup()" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 2px solid #e5e7eb; background: white; color: #64748b; font-size: 16px; min-width: 120px; transition: all 0.3s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                Cancel
                            </button>
                            <button onclick="window.confirmLogout()" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; background: linear-gradient(45deg, #ef4444, #dc2626); color: white; font-size: 16px; min-width: 120px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                Yes, Logout
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', popupHTML);

            // Show popup with animation
            const popup = document.getElementById('logout-popup');
            const container = popup.querySelector('.logout-popup-container');
            
            if (popup && container) {
                popup.offsetHeight; // Force reflow
                popup.style.opacity = '1';
                container.style.transform = 'scale(1)';
                
                // Add click outside to close
                popup.addEventListener('click', function(e) {
                    if (e.target === popup) {
                        window.hideLogoutPopup();
                    }
                });
            }
        };

        window.hideLogoutPopup = function() {
            const popup = document.getElementById('logout-popup');
            if (popup) {
                const container = popup.querySelector('.logout-popup-container');
                
                popup.style.opacity = '0';
                if (container) {
                    container.style.transform = 'scale(0.9)';
                }
                
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.remove();
                    }
                }, 300);
            }
        };

        window.confirmLogout = function() {
            // Hide the popup
            window.hideLogoutPopup();
            
            // Perform the actual logout
            if (window.sessionManager) {
                window.sessionManager.signOut();
            } else {
                // Fallback if session manager not available
                window.location.href = '/Wheelz_AI/html/signin.html';
            }
        };
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .user-info {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .profile-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3b82f6, #06b6d4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            border: 3px solid white;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .profile-details h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .profile-details p {
            color: #64748b;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .profile-details strong {
            color: #374151;
            font-weight: 600;
        }

        .session-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 14px;
            background: #f8fafc;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .session-item {
            text-align: center;
        }

        .session-label {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-value {
            color: #1e293b;
            font-weight: 500;
            font-size: 14px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            text-decoration: none;
            color: inherit;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .nav-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            transform: translateY(-4px);
            text-decoration: none;
            color: inherit;
        }

        .nav-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #3b82f6, #06b6d4);
        }

        .nav-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .nav-content {
            flex: 1;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .nav-description {
            color: #64748b;
            font-size: 14px;
            line-height: 1.4;
        }

        .nav-arrow {
            color: #94a3b8;
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .nav-card:hover .nav-arrow {
            transform: translateX(4px);
        }

        .stats-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stats-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .logout-card {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        .logout-card:hover {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
        }

        .logout-card .nav-title,
        .logout-card .nav-description {
            color: white;
        }

        .logout-card .nav-arrow {
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .activity-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }

        .activity-indicator.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            display: none;
        }

        .session-warning.show {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .welcome-message {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            color: #64748b;
            font-size: 16px;
        }

        .refresh-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .refresh-button:hover {
            background: #2563eb;
        }

        /* Enhanced Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: relative;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .chatbot-toggle svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUpLeft 0.3s ease;
        }

        .chatbot-window.active {
            display: flex;
        }

        @keyframes slideUpLeft {
            from {
                opacity: 0;
                transform: translateY(20px) translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(0);
            }
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8fafc;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            animation: messageSlide 0.3s ease;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            background: white;
            color: #333;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end;
        }

        .chatbot-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .chatbot-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chatbot-input {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .chatbot-input:focus {
            border-color: #667eea;
        }

        .chatbot-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .chatbot-send:hover {
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chatbot-send svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            max-width: 80px;
            align-self: flex-start;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #94a3b8;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .quick-questions {
            margin: 15px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .quick-questions-header {
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .quick-question {
            background: white;
            border: 1px solid #d1d5db;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            text-align: left;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 8px;
            display: block;
        }

        .quick-question:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin: 5px 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .profile-section {
                flex-direction: column;
                text-align: center;
            }
            
            .session-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-card {
                padding: 20px;
            }

            .chatbot-container {
                bottom: 15px;
                left: 15px;
            }
            
            .chatbot-window {
                width: calc(100vw - 30px);
                height: 70vh;
                bottom: 80px;
                left: 0;
            }

            .activity-indicator {
                bottom: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-spinner" class="loading-container" style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); z-index: 9999;">
        <div class="loading-spinner"></div>
        <p class="text-lg text-gray-700 mt-4">Loading your dashboard...</p>
        <p class="text-sm text-gray-500 mt-2">Please wait while we verify your session</p>
    </div>

    <!-- Session Warning -->
    <div id="session-warning" class="session-warning">
        <div class="flex items-start justify-between">
            <div>
                <h4 class="font-semibold mb-1">Session Expiring Soon</h4>
                <p class="text-sm" id="warning-message">Your session will expire in 5 minutes due to inactivity.</p>
            </div>
            <button onclick="extendSession()" class="ml-4 bg-white text-orange-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100">
                Extend
            </button>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" class="container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="welcome-message" id="welcome-message">Welcome to Your Dashboard!</div>
            <div class="welcome-subtitle">Manage your vehicle trading activities and account settings</div>
        </div>

        <!-- User Info Section -->
        <div class="user-info">
            <div class="profile-section">
                <div class="profile-avatar" id="profile-avatar">U</div>
                <div class="profile-details">
                    <h2 id="user-name">Loading...</h2>
                    <p><strong>Email:</strong> <span id="user-email">Loading...</span></p>
                    <p><strong>Account Type:</strong> <span id="user-type">Loading...</span></p>
                </div>
            </div>
            
            <div class="session-info">
                <div class="session-item">
                    <div class="session-label">Session Status</div>
                    <div class="session-value">Active</div>
                </div>
                <div class="session-item">
                    <div class="session-label">Session Time</div>
                    <div class="session-value" id="session-time">0 minutes</div>
                </div>
                <div class="session-item">
                    <div class="session-label">Last Activity</div>
                    <div class="session-value" id="last-activity">Just now</div>
                </div>
            </div>
        </div>

        <!-- Navigation Cards -->
        <div class="dashboard-grid">
            <a href="/Wheelz_AI/html/account.html" class="nav-card" data-navigate="account">
                <div class="nav-icon" style="background: linear-gradient(45deg, #3b82f6, #2563eb);">👤</div>
                <div class="nav-content">
                    <div class="nav-title">Account Details</div>
                    <div class="nav-description">Manage your profile information and personal settings</div>
                </div>
                <div class="nav-arrow">→</div>
            </a>

            <a href="/Wheelz_AI/html/ad_dashboard.html" class="nav-card" data-navigate="advertisements">
                <div class="nav-icon" style="background: linear-gradient(45deg, #10b981, #059669);">📢</div>
                <div class="nav-content">
                    <div class="nav-title">Your Advertisements</div>
                    <div class="nav-description">View and manage your vehicle listings and ads</div>
                </div>
                <div class="nav-arrow">→</div>
            </a>

            <a href="/Wheelz_AI/html/sell.html" class="nav-card" data-navigate="sell">
                <div class="nav-icon" style="background: linear-gradient(45deg, #f59e0b, #d97706);">🚗</div>
                <div class="nav-content">
                    <div class="nav-title">Sell a Vehicle</div>
                    <div class="nav-description">Post a new vehicle advertisement to find buyers</div>
                </div>
                <div class="nav-arrow">→</div>
            </a>

            <button class="nav-card logout-card" id="logoutButton" data-action="logout">
                <div class="nav-icon">🚪</div>
                <div class="nav-content">
                    <div class="nav-title">Logout</div>
                    <div class="nav-description">Sign out of your account securely</div>
                </div>
                <div class="nav-arrow">→</div>
            </button>
        </div>

        <!-- Statistics Section -->
        <div class="stats-section">
            <div class="stats-title">Account Overview</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="active-ads-count">-</div>
                    <div class="stat-label">Active Ads</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="profile-views-count">-</div>
                    <div class="stat-label">Profile Views</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="account-age-days">-</div>
                    <div class="stat-label">Days as Member</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-listings">-</div>
                    <div class="stat-label">Total Listings</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Indicator -->
    <div id="activity-indicator" class="activity-indicator">
        Session extended automatically
    </div>

    <!-- Enhanced Chatbot Container -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" id="chatbotToggle">
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
        </button>
        
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>WheelzAI Assistant 🇱🇰</h3>
                <button class="chatbot-close" id="chatbotClose">&times;</button>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages will be added here dynamically -->
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            
            <div class="chatbot-input-area">
                <div class="chatbot-input-container">
                    <textarea 
                        class="chatbot-input" 
                        id="chatbotInput" 
                        placeholder="Ask about vehicles, prices, regulations, or anything else..."
                        rows="1"
                    ></textarea>
                    <button class="chatbot-send" id="chatbotSend">
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Enhanced WheelzAI Chatbot Class with Gemini Integration
        class EnhancedWheelzAIChatbot {
            constructor() {
                this.isOpen = false;
                this.messages = [];
                this.conversationHistory = [];
                this.hasShownWelcome = false;
                
                // Replace with your actual Gemini API key
                this.GEMINI_API_KEY = 'AIzaSyCLW0c2OF0frOyKJtNnRMDH7WrByySs2Ww';
                
                // Predefined questions with answers
                this.predefinedQA = {
                    "Popular car brands in Sri Lanka": "The most popular car brands in Sri Lanka are:\n\n🚗 **Toyota** - Most popular, excellent resale value\n🚗 **Honda** - Reliable, good fuel economy\n🚗 **Nissan** - Affordable maintenance\n🚗 **Suzuki** - Budget-friendly options\n🚗 **Mitsubishi** - Good for SUVs\n\nToyota dominates with models like Prius, Aqua, and Allion being extremely popular.",
                    
                    "Hybrid vs petrol cars comparison": "**Hybrid vs Petrol Comparison:**\n\n🔋 **Hybrid Cars:**\n• Fuel economy: 20-25 km/l\n• Higher initial cost\n• Lower running costs\n• Complex maintenance\n• Better for city driving\n\n⛽ **Petrol Cars:**\n• Fuel economy: 12-16 km/l\n• Lower initial cost\n• Higher fuel costs\n• Simple maintenance\n• Good for all types of driving\n\n**Recommendation:** Choose hybrid for daily commuting, petrol for occasional use.",
                    
                    "Current fuel prices in Sri Lanka": "**Current Fuel Prices (Approximate):**\n\n⛽ Petrol 95: LKR 365/L\n⛽ Petrol 92: LKR 350/L\n🛢️ Diesel: LKR 320/L\n\n*Note: Prices change frequently based on global market conditions*\n\n**Fuel-efficient options:**\n• Hybrid cars: 20-25 km/l\n• Small petrol cars: 14-18 km/l\n• Diesel vehicles: 8-12 km/l",
                    
                    "Best family cars under LKR 6M": "**Best Family Cars Under LKR 6M:**\n\n🚗 **Toyota Vios** (LKR 5.2-5.7M)\n• Sedan body, more boot space\n• Comfortable for longer drives\n• Good resale value\n\n🚗 **Toyota Vitz** (LKR 5.5-6M)\n• Compact, fuel efficient, easy to park\n• Great for city driving and small families\n• Popular choice in Sri Lanka\n\n🚗 **Honda Fit** (LKR 5.5-5.8M)\n• Spacious interior, hybrid available\n• Excellent fuel economy and reliability\n• Versatile and practical\n\n🚗 **Suzuki Swift** (LKR 5.5-5.8M)\n• Sporty design, affordable maintenance\n• Good balance of performance and economy\n• Fun to drive\n\nAll offer good value, safety features, and are popular choices in Sri Lanka!",
                    
                    "Car import guide for Sri Lanka": "**Car Import Requirements:**\n\n📋 **Age Limits:**\n• Cars: Generally 5-7 years\n• Vans: Up to 8 years\n• Buses/Trucks: Up to 10 years\n\n💰 **Costs Involved:**\n• Import duty (varies by engine size)\n• Excise duty\n• VAT (15%)\n• Port charges\n• Agent fees\n\n✅ **Requirements:**\n• Import license\n• Emission compliance (Euro 4)\n• Pre-shipment inspection\n• Insurance\n\n**Tip:** Hybrid vehicles get duty concessions!",
                    
                    "How to use WheelzAI dashboard": "**Dashboard Navigation Guide:**\n\n👤 **Account Details:** Update your profile and settings\n📢 **Your Advertisements:** Manage your vehicle listings\n🚗 **Sell a Vehicle:** Create new advertisements\n💰 **Buy a Vehicle:** Browse the marketplace\n📊 **Account Overview:** View your statistics\n\n**Tips:**\n• Keep your profile updated for better visibility\n• Use high-quality photos in your ads\n• Set competitive prices for faster sales\n• Check your dashboard regularly for inquiries"
                };
                
                this.quickQuestions = Object.keys(this.predefinedQA);
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkAPIStatus();
            }

            checkAPIStatus() {
                if (this.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    console.warn('Gemini API key not configured. Using offline mode only.');
                }
            }

            bindEvents() {
                const toggle = document.getElementById('chatbotToggle');
                const close = document.getElementById('chatbotClose');
                const send = document.getElementById('chatbotSend');
                const input = document.getElementById('chatbotInput');

                if (toggle) toggle.addEventListener('click', () => this.toggleChat());
                if (close) close.addEventListener('click', () => this.closeChat());
                if (send) send.addEventListener('click', () => this.sendMessage());
                
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    // Auto-resize textarea
                    input.addEventListener('input', () => {
                        input.style.height = 'auto';
                        input.style.height = Math.min(input.scrollHeight, 100) + 'px';
                    });
                }
            }

            toggleChat() {
                const window = document.getElementById('chatbotWindow');
                if (!window) return;
                
                this.isOpen = !this.isOpen;
                
                if (this.isOpen) {
                    window.classList.add('active');
                    const input = document.getElementById('chatbotInput');
                    if (input) input.focus();
                    
                    // Show welcome message and questions only when first opened
                    if (!this.hasShownWelcome) {
                        setTimeout(() => {
                            this.addWelcomeMessage();
                            this.hasShownWelcome = true;
                        }, 300);
                    }
                } else {
                    window.classList.remove('active');
                }
            }

            closeChat() {
                const window = document.getElementById('chatbotWindow');
                if (window) {
                    window.classList.remove('active');
                    this.isOpen = false;
                }
            }

            addWelcomeMessage() {
                const welcomeMsg = "Ayubowan! Welcome to WheelzAI! 🇱🇰\n\nI'm your Sri Lankan vehicle assistant powered by Google Gemini AI. I can help with vehicle information, prices, and answer any questions you have!\n\nChoose a quick question below or ask me anything:";
                this.addMessage('bot', welcomeMsg);
                
                // Add questions immediately after welcome message
                setTimeout(() => {
                    this.addQuickQuestions();
                }, 100);
            }

            addMessage(sender, text, isHtml = false) {
                const messagesContainer = document.getElementById('chatbotMessages');
                if (!messagesContainer) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                if (isHtml) {
                    messageDiv.innerHTML = text;
                } else {
                    messageDiv.textContent = text;
                }
                
                this.messages.push({ sender, text, timestamp: new Date() });
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            addQuickQuestions() {
                const messagesContainer = document.getElementById('chatbotMessages');
                
                if (!messagesContainer) {
                    console.error('Messages container not found');
                    return;
                }
                
                // Create a visible container for the questions
                const questionsContainer = document.createElement('div');
                questionsContainer.className = 'quick-questions';
                
                // Add header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'quick-questions-header';
                headerDiv.textContent = '💡 Popular Questions - Click any to get instant answers:';
                questionsContainer.appendChild(headerDiv);
                
                // Add each question as a clickable button
                this.quickQuestions.forEach((question, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-question';
                    btn.textContent = `${index + 1}. ${question}`;
                    
                    btn.addEventListener('click', () => {
                        this.handleQuickQuestion(question);
                    });
                    
                    questionsContainer.appendChild(btn);
                });
                
                messagesContainer.appendChild(questionsContainer);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                console.log('Quick questions added successfully');
            }

            handleQuickQuestion(question) {
                // Add user message
                this.addMessage('user', question);
                
                // Show typing indicator
                this.showTypingIndicator();
                
                setTimeout(() => {
                    this.hideTypingIndicator();
                    const answer = this.predefinedQA[question];
                    this.addMessage('bot', answer);
                }, 1000);
            }

            showTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                const messagesContainer = document.getElementById('chatbotMessages');
                if (indicator && messagesContainer) {
                    indicator.style.display = 'flex';
                    messagesContainer.appendChild(indicator);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            async sendMessage() {
                const input = document.getElementById('chatbotInput');
                const sendButton = document.getElementById('chatbotSend');
                if (!input) return;

                const message = input.value.trim();
                if (!message) return;
                
                // Disable input during processing
                if (sendButton) sendButton.disabled = true;
                input.disabled = true;
                
                // Add user message
                this.addMessage('user', message);
                this.conversationHistory.push({ role: "user", content: message });
                
                input.value = '';
                input.style.height = 'auto';
                
                // Show typing indicator
                this.showTypingIndicator();
                
                try {
                    // Try to get response from Gemini API
                    const response = await this.getGeminiResponse(message);
                    this.hideTypingIndicator();
                    this.addMessage('bot', response + " <span style='display: inline-block; background: linear-gradient(135deg, #4285f4 0%, #ea4335 50%, #fbbc04 100%); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px; font-weight: 500;'>Gemini</span>", true);
                    this.conversationHistory.push({ role: "assistant", content: response });
                } catch (error) {
                    console.error('Gemini API error:', error);
                    this.hideTypingIndicator();
                    
                    // Use enhanced fallback responses
                    const fallbackResponse = this.getEnhancedResponse(message);
                    this.addMessage('bot', fallbackResponse);
                    
                    if (this.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                        this.addErrorMessage("Gemini API key not configured. Using offline responses.");
                    } else {
                        this.addErrorMessage("Gemini API temporarily unavailable. Using offline responses.");
                    }
                }
                
                // Re-enable input
                if (sendButton) sendButton.disabled = false;
                input.disabled = false;
                input.focus();
            }

            async getGeminiResponse(message) {
                if (this.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    throw new Error('API key not configured');
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are WheelzAI, a helpful assistant for Sri Lankan vehicle buyers and sellers. You specialize in:
- Sri Lankan vehicle market information
- Car prices, models, and recommendations  
- Import regulations and duties
- Vehicle comparisons and advice
- Local dealer and location information
- Dashboard and platform guidance

Context: This is a vehicle trading platform in Sri Lanka called WheelzAI. The user is currently on their dashboard where they can manage their account, view advertisements, sell vehicles, and buy vehicles.

Current Sri Lankan vehicle market context:
- Toyota Vitz: LKR 5.5-6M
- Honda Fit: LKR 5.5-5.8M
- Suzuki Swift: LKR 5.5-5.8M  
- Toyota Vios: LKR 5.2-5.7M
- Toyota Aqua: LKR 6-8.5M
- Honda Grace: LKR 6.5-8.5M

User question: ${message}

Please provide a helpful response that's specific to Sri Lanka when relevant. Keep responses concise but informative (under 200 words).`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 300,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Gemini API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Invalid response format from Gemini API');
                }
            }

            getEnhancedResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Check for exact matches with predefined questions
                for (const [question, answer] of Object.entries(this.predefinedQA)) {
                    if (lowerMessage.includes(question.toLowerCase().substring(0, 10))) {
                        return answer;
                    }
                }
                
                // Greeting patterns
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey') || lowerMessage.includes('ayubowan')) {
                    return "Ayubowan! 🙏 Welcome to WheelzAI! I'm here to help you with Sri Lankan vehicle information. What would you like to know?";
                }
                
                // Vehicle brand specific queries
                if (lowerMessage.includes('toyota')) {
                    return "Toyota is the most popular brand in Sri Lanka! Popular models include:\n• Vios (LKR 5.2-5.7M) - Sedan\n• Vitz (LKR 5.5-6M) - Compact\n• Aqua (LKR 6-8.5M) - Hybrid\n• Prius (LKR 6.5-12M) - Premium hybrid\n\nWhich Toyota model interests you?";
                }
                
                if (lowerMessage.includes('honda')) {
                    return "Honda vehicles in Sri Lanka:\n• Fit (LKR 5.5-5.8M) - Compact, versatile\n• Grace (LKR 6.5-8.5M) - Hybrid sedan\n• Civic (LKR 8-12M) - Premium sedan\n• CR-V (LKR 12-18M) - SUV\n\nWhich Honda model would you like to know about?";
                }
                
                if (lowerMessage.includes('suzuki')) {
                    return "Suzuki vehicles in Sri Lanka:\n• Swift (LKR 5.5-5.8M) - Sporty compact\n• Alto (LKR 3.5-4.5M) - Budget option\n• Wagon R (LKR 4-5M) - Practical choice\n• Vitara (LKR 8-12M) - SUV\n\nAll known for affordable maintenance!";
                }
                
                // Price-related queries
                if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('budget')) {
                    return "Vehicle price ranges in Sri Lanka:\n\n💰 Budget (Under LKR 4M):\nAlto, March, older Vitz\n\n💰 Mid-range (LKR 4-6M):\nVios, Vitz, Fit, Swift\n\n💰 Premium (LKR 6-10M):\nAqua, Grace, Prius\n\nWhat's your budget range?";
                }
                
                // Hybrid vs petrol
                if (lowerMessage.includes('hybrid') || lowerMessage.includes('fuel')) {
                    return this.predefinedQA["Hybrid vs petrol cars comparison"];
                }
                
                // Import information
                if (lowerMessage.includes('import') || lowerMessage.includes('duty') || lowerMessage.includes('tax')) {
                    return this.predefinedQA["Car import guide for Sri Lanka"];
                }
                
                // Selling help
                if (lowerMessage.includes('sell') || lowerMessage.includes('selling')) {
                    return "To sell your vehicle on WheelzAI:\n\n1. Click 'Sell a Vehicle' from your dashboard\n2. Upload clear photos from multiple angles\n3. Fill in accurate vehicle details\n4. Set a competitive price\n5. Write a detailed description\n6. Respond quickly to inquiries\n\n💡 Tips:\n• Clean your car before photos\n• Include service history\n• Be honest about any issues";
                }
                
                // Buying help
                if (lowerMessage.includes('buy') || lowerMessage.includes('buying') || lowerMessage.includes('purchase')) {
                    return "Tips for buying a vehicle in Sri Lanka:\n\n✅ **Before viewing:**\n• Research market prices\n• Check vehicle history if possible\n• Arrange financing if needed\n\n✅ **During inspection:**\n• Check engine, brakes, tires\n• Test drive in different conditions\n• Verify all documents\n\n✅ **Before purchase:**\n• Get a mechanic's inspection\n• Negotiate based on condition\n• Transfer ownership properly";
                }
                
                // Dashboard help
                if (lowerMessage.includes('dashboard') || lowerMessage.includes('account') || lowerMessage.includes('profile')) {
                    return this.predefinedQA["How to use WheelzAI dashboard"];
                }
                
                // Thank you
                if (lowerMessage.includes('thank')) {
                    return "You're very welcome! 😊 I'm here to help with any Sri Lankan vehicle questions. Feel free to ask about specific models, prices, or anything else!";
                }
                
                // Goodbye
                if (lowerMessage.includes('bye') || lowerMessage.includes('goodbye')) {
                    return "Thank you for using WheelzAI! Feel free to come back anytime for vehicle information. Safe driving! 🚗✨";
                }
                
                // Default response with suggestions
                return "I can help you with Sri Lankan vehicle information! Try asking about:\n\n🚗 **Specific models:** \"Toyota Vitz price\" or \"Honda Fit review\"\n💰 **Budgets:** \"Cars under 6M\" or \"Best family cars\"\n🔧 **Comparisons:** \"Hybrid vs petrol\" or \"Toyota vs Honda\"\n📊 **Platform help:** \"How to sell\" or \"Dashboard guide\"\n⛽ **Market info:** \"Fuel prices\" or \"Import duties\"\n\nWhat interests you most?";
            }

            addErrorMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                if (!messagesContainer) return;
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                messagesContainer.appendChild(errorDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOamMqCPIzJurf85fjBleVmWffdscEslM",
            authDomain: "wheelzai.firebaseapp.com",
            projectId: "wheelzai",
            storageBucket: "wheelzai.firebasestorage.app",
            messagingSenderId: "132756052907",
            appId: "1:132756052907:web:b92dc998b4b5bee8d450ee",
            measurementId: "G-ECQJYZYK43"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();


        
        class SessionManager {
            constructor() {
                this.auth = firebase.auth();
                this.db = firebase.firestore();
                this.currentUser = null;
                this.userProfile = null;
                this.sessionTimeout = 30 * 60 * 1000; // 30 minutes
                this.warningTimeout = 25 * 60 * 1000; // 25 minutes
                this.sessionWarningShown = false;
                this.heartbeatInterval = null;
                this.sessionStartTime = Date.now();
                this.lastActivityTime = Date.now();
            }

            async init() {
                return new Promise((resolve) => {
                    this.auth.onAuthStateChanged(async (user) => {
                        this.currentUser = user;
                        if (user) {
                            await this.loadUserProfile();
                            this.startSessionMonitoring();
                            this.setupActivityListeners();
                            this.updateUI();
                            this.showDashboard();
                        } else {
                            this.redirectToLogin();
                        }
                        resolve(user);
                    });
                });
            }

            async loadUserProfile() {
                if (!this.currentUser) {
                    console.log('No current user, skipping profile load');
                    return;
                }
                
                try {
                    console.log('Loading user profile for UID:', this.currentUser.uid);
                    
                    const doc = await this.db.collection('users').doc(this.currentUser.uid).get();
                    
                    if (doc.exists) {
                        this.userProfile = doc.data();
                        console.log('User profile loaded:', this.userProfile);
                    } else {
                        console.log('User profile document does not exist, creating default profile');
                        
                        // Create a default user profile if it doesn't exist
                        const defaultProfile = {
                            name: this.currentUser.displayName || 'User',
                            email: this.currentUser.email,
                            userType: 'seller',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            profileViews: 0
                        };
                        
                        // Save the default profile to Firestore
                        await this.db.collection('users').doc(this.currentUser.uid).set(defaultProfile);
                        this.userProfile = defaultProfile;
                        
                        console.log('Default user profile created:', defaultProfile);
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    console.error('Error details:', {
                        code: error.code,
                        message: error.message
                    });
                    
                    // Set a minimal default profile
                    this.userProfile = {
                        name: this.currentUser.displayName || 'User',
                        email: this.currentUser.email,
                        userType: 'seller',
                        profileViews: 0
                    };
                }
            }

            updateUI() {
                if (!this.currentUser) return;

                // Get user name
                const userName = this.currentUser.displayName || this.userProfile?.name || 'User';
                
                // Update avatar
                const avatar = document.getElementById('profile-avatar');
                if (avatar) {
                    avatar.textContent = userName.charAt(0).toUpperCase();
                }

                // Update user info
                const welcomeMessage = document.getElementById('welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.textContent = `Welcome back, ${userName}!`;
                }

                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = userName;
                }

                const userEmailElement = document.getElementById('user-email');
                if (userEmailElement) {
                    userEmailElement.textContent = this.currentUser.email;
                }

                const userTypeElement = document.getElementById('user-type');
                if (userTypeElement) {
                    userTypeElement.textContent = (this.userProfile?.userType || 'seller').charAt(0).toUpperCase() + (this.userProfile?.userType || 'seller').slice(1);
                }

                // Update session info
                this.updateSessionTime();
                this.updateLastActivity();
                this.loadAccountStats();
            }

            async loadAccountStats() {
                try {
                    console.log('Loading account stats for user:', this.currentUser.uid);
                    
                    // Get active advertisements count
                    const adsQuery = this.db.collection('Advertisements')
                        .where('userId', '==', this.currentUser.uid)
                        .where('status', '==', 'active');
                    
                    console.log('Executing ads query...');
                    const adsSnapshot = await adsQuery.get();
                    console.log('Active ads found:', adsSnapshot.size);
                    
                    const activeAdsElement = document.getElementById('active-ads-count');
                    if (activeAdsElement) {
                        activeAdsElement.textContent = adsSnapshot.size;
                    }

                    // Get total listings (all advertisements regardless of status)
                    const allListingsQuery = this.db.collection('Advertisements')
                        .where('userId', '==', this.currentUser.uid);
                    
                    console.log('Executing total listings query...');
                    const allListingsSnapshot = await allListingsQuery.get();
                    console.log('Total listings found:', allListingsSnapshot.size);
                    
                    const totalListingsElement = document.getElementById('total-listings');
                    if (totalListingsElement) {
                        totalListingsElement.textContent = allListingsSnapshot.size;
                    }

                    // Calculate account age
                    if (this.userProfile?.createdAt) {
                        try {
                            const createdDate = this.userProfile.createdAt.toDate ? 
                                this.userProfile.createdAt.toDate() : 
                                new Date(this.userProfile.createdAt);
                            
                            const daysDiff = Math.floor((Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24));
                            console.log('Account age in days:', daysDiff);
                            
                            const accountAgeElement = document.getElementById('account-age-days');
                            if (accountAgeElement) {
                                accountAgeElement.textContent = Math.max(1, daysDiff); // Minimum 1 day
                            }
                        } catch (dateError) {
                            console.error('Error calculating account age:', dateError);
                            const accountAgeElement = document.getElementById('account-age-days');
                            if (accountAgeElement) {
                                accountAgeElement.textContent = '1';
                            }
                        }
                    } else {
                        console.log('No createdAt found in user profile');
                        const accountAgeElement = document.getElementById('account-age-days');
                        if (accountAgeElement) {
                            accountAgeElement.textContent = '1';
                        }
                    }

                    // Profile views (get from user profile or default to 0)
                    const profileViews = this.userProfile?.profileViews || 0;
                    console.log('Profile views:', profileViews);
                    
                    const profileViewsElement = document.getElementById('profile-views-count');
                    if (profileViewsElement) {
                        profileViewsElement.textContent = profileViews;
                    }

                    console.log('Account stats loaded successfully');

                } catch (error) {
                    console.error('Error loading account stats:', error);
                    console.error('Error details:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Set default values if there's an error
                    const defaultValues = {
                        'active-ads-count': '0',
                        'account-age-days': '1',
                        'total-listings': '0',
                        'profile-views-count': '0'
                    };
                    
                    Object.entries(defaultValues).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                    
                    // Show user-friendly error message
                    console.warn('Using default values due to error loading stats');
                }
            }

            // Add refresh stats method
            async refreshStats() {
                console.log('Manually refreshing account stats...');
                
                // Show loading state
                const statElements = [
                    'active-ads-count',
                    'total-listings', 
                    'account-age-days',
                    'profile-views-count'
                ];
                
                statElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = '...';
                    }
                });
                
                // Reload user profile and stats
                await this.loadUserProfile();
                await this.loadAccountStats();
                
                console.log('Stats refresh completed');
            }

            updateSessionTime() {
                const sessionTimeElement = document.getElementById('session-time');
                if (sessionTimeElement) {
                    const elapsed = Date.now() - this.sessionStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    sessionTimeElement.textContent = `${minutes} minutes`;
                }
            }

            updateLastActivity() {
                this.lastActivityTime = Date.now();
                const activityElement = document.getElementById('last-activity');
                if (activityElement) {
                    activityElement.textContent = 'Just now';
                }
                
                // Hide session warning if shown
                this.sessionWarningShown = false;
                this.hideSessionWarning();
            }

            setupActivityListeners() {
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                
                const throttledUpdate = this.throttle(() => {
                    this.updateLastActivity();
                    this.showActivityIndicator();
                }, 30000);

                events.forEach(event => {
                    document.addEventListener(event, throttledUpdate, true);
                });

                // Update activity time display every minute
                setInterval(() => {
                    this.updateActivityTimeDisplay();
                    this.updateSessionTime();
                }, 60000);
            }

            updateActivityTimeDisplay() {
                const activityElement = document.getElementById('last-activity');
                if (activityElement) {
                    const elapsed = Date.now() - this.lastActivityTime;
                    const minutes = Math.floor(elapsed / 60000);
                    
                    if (minutes === 0) {
                        activityElement.textContent = 'Just now';
                    } else if (minutes === 1) {
                        activityElement.textContent = '1 minute ago';
                    } else {
                        activityElement.textContent = `${minutes} minutes ago`;
                    }
                }
            }

            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }

            startSessionMonitoring() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }

                this.heartbeatInterval = setInterval(() => {
                    this.checkSessionStatus();
                }, 60000);
            }

            checkSessionStatus() {
                const now = Date.now();
                const timeSinceActivity = now - this.lastActivityTime;

                if (timeSinceActivity > this.warningTimeout && !this.sessionWarningShown) {
                    this.showSessionWarning();
                }

                if (timeSinceActivity > this.sessionTimeout) {
                    this.handleSessionTimeout();
                }
            }

            showSessionWarning() {
                this.sessionWarningShown = true;
                const warningElement = document.getElementById('session-warning');
                const messageElement = document.getElementById('warning-message');
                
                const timeLeft = Math.ceil((this.sessionTimeout - this.warningTimeout) / 60000);
                messageElement.textContent = `Your session will expire in ${timeLeft} minutes due to inactivity.`;
                
                warningElement.classList.add('show');
                
                // Auto-hide after 10 seconds if no action
                setTimeout(() => {
                    if (this.sessionWarningShown) {
                        this.hideSessionWarning();
                    }
                }, 10000);
            }

            hideSessionWarning() {
                const warningElement = document.getElementById('session-warning');
                warningElement.classList.remove('show');
            }

            handleSessionTimeout() {
                alert('Your session has expired due to inactivity. Please sign in again.');
                this.signOut();
            }

            showActivityIndicator() {
                const indicator = document.getElementById('activity-indicator');
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            showDashboard() {
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                // Load enhanced chatbot after dashboard is shown
                setTimeout(() => {
                    this.initializeChatbot();
                }, 500);
            }

            initializeChatbot() {
                try {
                    window.enhancedWheelzAIChatbot = new EnhancedWheelzAIChatbot();
                    console.log('Enhanced WheelzAI Chatbot initialized successfully');
                } catch (error) {
                    console.error('Error initializing enhanced chatbot:', error);
                }
            }

            redirectToLogin() {
                console.log('No user authenticated. Redirecting to login.');
                window.location.href = '/Wheelz_AI/html/signin.html';
            }

            async signOut() {
                try {
                    if (this.heartbeatInterval) {
                        clearInterval(this.heartbeatInterval);
                    }
                    
                    sessionStorage.clear();
                    localStorage.removeItem('wheelzai_remember_me');
                    
                    await this.auth.signOut();
                    console.log('User logged out successfully.');
                } catch (error) {
                    console.error('Logout failed:', error);
                    this.redirectToLogin();
                }
            }
        }

        // Global functions for UI interactions
        function extendSession() {
            sessionManager.updateLastActivity();
            sessionManager.hideSessionWarning();
            sessionManager.showActivityIndicator();
        }

        // Global function for refreshing stats
        window.refreshDashboardStats = function() {
            if (window.sessionManager) {
                window.sessionManager.refreshStats();
            }
        };

        // Function to add refresh button (optional)
        function addRefreshButton() {
            const statsSection = document.querySelector('.stats-section');
            if (statsSection && !document.querySelector('.refresh-button')) {
                const refreshButton = document.createElement('button');
                refreshButton.textContent = '🔄 Refresh Stats';
                refreshButton.className = 'refresh-button';
                
                refreshButton.addEventListener('click', () => {
                    window.refreshDashboardStats();
                });
                
                const statsTitle = statsSection.querySelector('.stats-title');
                if (statsTitle) {
                    statsTitle.insertAdjacentElement('afterend', refreshButton);
                }
            }
        }

        // Initialize session manager
        const sessionManager = new SessionManager();

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Dashboard initializing...');
            await sessionManager.init();
            
            // Add refresh button for testing
            addRefreshButton();
            
            // Set up logout button
            const logoutButton = document.getElementById('logoutButton');
            logoutButton.addEventListener('click', async (e) => {
                e.preventDefault();
                // Show custom logout popup instead of browser confirm
                window.showLogoutPopup();
            });

            // Set up navigation tracking
            const navButtons = document.querySelectorAll('[data-navigate]');
            navButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const destination = e.currentTarget.getAttribute('data-navigate');
                    console.log(`Navigating to: ${destination}`);
                });
            });

            console.log('Dashboard initialized successfully');
        });

        // Make session manager globally available
        window.wheelzAISession = sessionManager;
        window.sessionManager = sessionManager;
    </script>
</body>
</html>