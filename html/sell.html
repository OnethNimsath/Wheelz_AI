<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Your Vehicle - WheelzAI</title>
    <script src="/Wheelz_AI/Javascript/price_predictor_client.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOamMqCPIzJurf85fjBleVmWffdscEslM",
            authDomain: "wheelzai.firebaseapp.com",
            projectId: "wheelzai",
            storageBucket: "wheelzai.firebasestorage.app",
            messagingSenderId: "132756052907",
            appId: "1:132756052907:web:b92dc998b4b5bee8d450ee",
            measurementId: "G-ECQJYZYK43"
        };

        // Initialize Firebase
        console.log('Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        console.log('Firebase initialized successfully');

        // Make Firebase functions globally available
        window.db = db;
        window.storage = storage;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.signOut = signOut;
        
        // Session Management
        let currentUser = null;
        let isPageReady = false;
        
        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ User is authenticated:', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName
                });
                
                // Store session info
                sessionStorage.setItem('wheelzai_user', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                }));
                
                // Show the page content
                showPageContent();
                
                // Update UI with user info
                updateUserInterface(user);
                
            } else {
                console.log('‚ùå User is not authenticated');
                currentUser = null;
                
                // Clear session
                sessionStorage.removeItem('wheelzai_user');
                
                // Show authentication required message
                showAuthRequired();
            }
        });
        
        // Function to show page content (when authenticated)
        function showPageContent() {
            if (isPageReady) return;
            isPageReady = true;
            
            const loadingElement = document.getElementById('loading');
            const contentElement = document.getElementById('content');
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (contentElement) contentElement.style.display = 'block';
        }
        
        // Function to show authentication required
        function showAuthRequired() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-6xl mb-4">üîí</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Authentication Required</h2>
                        <p class="text-gray-600 mb-4">Please log in to access the vehicle listing page</p>
                        <div class="space-y-3">
                            <button onclick="window.location.href='index.html'" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                Go to Login
                            </button>
                            <p class="text-sm text-gray-500">Redirecting in <span id="countdown">3</span> seconds...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Countdown and redirect
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            const interval = setInterval(() => {
                countdown--;
                if (countdownElement) countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    window.location.href = 'index.html';
                }
            }, 1000);
        }
        
        // Function to update UI with user information
        function updateUserInterface(user) {
            setTimeout(() => {
                const userInfoElement = document.getElementById('userInfo');
                if (userInfoElement) {
                    userInfoElement.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                ${user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase()}
                            </div>
                            <span class="text-gray-700">${user.displayName || user.email}</span>
                        </div>
                    `;
                    userInfoElement.classList.remove('hidden');
                }
            }, 500);
        }
        
        // Global logout function
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error signing out. Please try again.');
            }
        };
        
        // Function to get current user
        window.getCurrentUser = function() {
            return currentUser;
        };
        
        // Test functions
        window.testFirebaseConnection = async function() {
            try {
                const testDoc = {
                    test: true,
                    timestamp: serverTimestamp(),
                    userId: currentUser?.uid || 'anonymous'
                };
                const docRef = await addDoc(collection(db, 'test'), testDoc);
                alert('Firebase connection successful! Test document ID: ' + docRef.id);
                return true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                alert('Firebase connection failed: ' + error.message);
                return false;
            }
        };
        
        console.log('Firebase setup complete with session management.');
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }
        
        .step-completed {
            background: #10b981;
            color: white;
        }
        
        .step-default {
            background: #e2e8f0;
            color: #64748b;
        }
        
        .form-step {
            display: none;
            animation: fadeInUp 0.5s ease;
        }
        
        .form-step.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8faff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #e0e7ff;
        }
        
        .floating-label {
            transform: translateY(0.5rem);
            transition: all 0.2s ease;
            color: #64748b;
        }
        
        .floating-label.active {
            transform: translateY(-1.25rem);
            font-size: 0.75rem;
            color: #667eea;
        }
        
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            background-color: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .custom-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .custom-select option {
            background: white;
            color: #374151;
            padding: 0.5rem;
        }
        
        .form-input {
            background-color: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input::placeholder {
            color: #9ca3af;
        }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        #content {
            display: none;
        }

        /* Voice-to-Text Styles */
        .voice-input-container {
            position: relative;
        }

        .voice-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 2s infinite;
        }

        .voice-button.processing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .voice-status {
            position: absolute;
            top: -35px;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .voice-status.visible {
            opacity: 1;
        }

        .textarea-with-voice {
            padding-right: 60px !important;
        }

        .voice-visualization {
            position: absolute;
            bottom: 60px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .voice-visualization.active {
            opacity: 1;
        }

        .voice-bar {
            width: 3px;
            height: 10px;
            background: #667eea;
            border-radius: 2px;
            animation: voiceBar 0.5s ease-in-out infinite alternate;
        }

        .voice-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes voiceBar {
            from { height: 4px; }
            to { height: 16px; }
        }

        /* Integrated Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px; /* Changed from left to right for better positioning */
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: relative;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .chatbot-toggle svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0; /* Changed from left to right */
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUpRight 0.3s ease; /* Changed animation */
        }

        .chatbot-window.active {
            display: flex;
        }

        @keyframes slideUpRight {
            from {
                opacity: 0;
                transform: translateY(20px) translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(0);
            }
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8fafc;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            animation: messageSlide 0.3s ease;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            background: white;
            color: #333;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end;
        }

        .chatbot-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .chatbot-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chatbot-input {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .chatbot-input:focus {
            border-color: #667eea;
        }

        .chatbot-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .chatbot-send:hover {
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chatbot-send svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            max-width: 80px;
            align-self: flex-start;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #94a3b8;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .quick-questions {
            margin: 15px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .quick-questions-header {
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .quick-question {
            background: white;
            border: 1px solid #d1d5db;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            text-align: left;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 8px;
            display: block;
        }

        .quick-question:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .gemini-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4285f4 0%, #ea4335 50%, #fbbc04 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin: 5px 0;
        }

        .api-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin: 5px 0;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .chatbot-container {
                bottom: 15px;
                right: 15px;
            }
            
            .chatbot-window {
                width: calc(100vw - 30px);
                height: 70vh;
                bottom: 80px;
                right: 0;
            }
        }

        /* Help hint for selling page specific */
        .chatbot-help-hint {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            animation: fadeInOut 4s ease-in-out;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            20%, 80% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Loading State -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading...</p>
        </div>
    </div>
    
    <!-- Main Content (Hidden until authenticated) -->
    <div id="content">
        <div class="container mx-auto px-4 py-8">
            <!-- Header with Navigation -->
            <div class="flex justify-between items-center mb-8">
                <div class="text-center flex-1">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Sell Your Vehicle</h1>
                    <p class="text-gray-600">Get the best price for your vehicle with our AI-powered valuation</p>
                </div>
                
                <!-- User Info & Navigation -->
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            üè† Dashboard
                        </button>
                        <button onclick="handleLogout()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="progressBar" class="progress-bar h-full bg-gradient-to-r from-purple-500 to-blue-500 rounded-full" style="width: 25%"></div>
                </div>
            </div>

            <!-- Step Indicators -->
            <div class="flex justify-center mb-8">
                <div class="flex space-x-4">
                    <div class="step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                    <div class="step-indicator step-default w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                    <div class="step-indicator step-default w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                    <div class="step-indicator step-default w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                </div>
            </div>

            <!-- Main Form Container -->
            <div class="max-w-4xl mx-auto">
                <div class="glass-effect rounded-2xl p-8">
                    <form id="vehicleForm">
                        <!-- Step 1: Basic Information -->
                        <div class="form-step active" data-step="1">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Basic Information</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Vehicle Make</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Make</option>
                                        <option value="toyota">Toyota</option>
                                        <option value="honda">Honda</option>
                                        <option value="ford">Ford</option>
                                        <option value="chevrolet">Chevrolet</option>
                                        <option value="nissan">Nissan</option>
                                        <option value="hyundai">Hyundai</option>
                                        <option value="bmw">BMW</option>
                                        <option value="mercedes">Mercedes-Benz</option>
                                        <option value="audi">Audi</option>
                                        <option value="volkswagen">Volkswagen</option>
                                    </select>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Model</label>
                                    <input type="text" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Year</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Year</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                        <option value="2020">2020</option>
                                        <option value="2019">2019</option>
                                        <option value="2018">2018</option>
                                        <option value="2017">2017</option>
                                        <option value="2016">2016</option>
                                        <option value="2015">2015</option>
                                    </select>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Mileage</label>
                                    <input type="number" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Body Type</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Body Type</option>
                                        <option value="sedan">Sedan</option>
                                        <option value="suv">SUV</option>
                                        <option value="hatchback">Hatchback</option>
                                        <option value="coupe">Coupe</option>
                                        <option value="convertible">Convertible</option>
                                        <option value="wagon">Wagon</option>
                                        <option value="truck">Truck</option>
                                        <option value="van">Van</option>
                                    </select>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Fuel Type</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Fuel Type</option>
                                        <option value="gasoline">Gasoline</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="hybrid">Hybrid</option>
                                        <option value="electric">Electric</option>
                                        <option value="plugin-hybrid">Plug-in Hybrid</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Vehicle Condition -->
                        <div class="form-step" data-step="2">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Vehicle Condition</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Overall Condition</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <label class="relative cursor-pointer">
                                            <input type="radio" name="condition" value="excellent" class="sr-only">
                                            <div class="condition-card p-6 border-2 border-gray-200 rounded-lg text-center transition-all hover:border-purple-400 hover:bg-purple-50">
                                                <div class="text-3xl mb-2">‚≠ê</div>
                                                <div class="text-gray-800 font-medium">Excellent</div>
                                                <div class="text-gray-600 text-sm">Like new condition</div>
                                            </div>
                                        </label>
                                        <label class="relative cursor-pointer">
                                            <input type="radio" name="condition" value="good" class="sr-only">
                                            <div class="condition-card p-6 border-2 border-gray-200 rounded-lg text-center transition-all hover:border-purple-400 hover:bg-purple-50">
                                                <div class="text-3xl mb-2">üëç</div>
                                                <div class="text-gray-800 font-medium">Good</div>
                                                <div class="text-gray-600 text-sm">Minor wear and tear</div>
                                            </div>
                                        </label>
                                        <label class="relative cursor-pointer">
                                            <input type="radio" name="condition" value="fair" class="sr-only">
                                            <div class="condition-card p-6 border-2 border-gray-200 rounded-lg text-center transition-all hover:border-purple-400 hover:bg-purple-50">
                                                <div class="text-3xl mb-2">üîß</div>
                                                <div class="text-gray-800 font-medium">Fair</div>
                                                <div class="text-gray-600 text-sm">Needs some repairs</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="relative">
                                        <label class="floating-label active absolute left-3 pointer-events-none">Accident History</label>
                                        <select class="custom-select w-full p-4 pt-6 rounded-lg">
                                            <option value="none">No Accidents</option>
                                            <option value="minor">Minor Accidents</option>
                                            <option value="major">Major Accidents</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label active absolute left-3 pointer-events-none">Service History</label>
                                        <select class="custom-select w-full p-4 pt-6 rounded-lg">
                                            <option value="complete">Complete Service Records</option>
                                            <option value="partial">Partial Service Records</option>
                                            <option value="none">No Service Records</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Additional Notes</label>
                                    <div class="voice-input-container">
                                        <textarea 
                                            id="additionalNotes"
                                            class="form-input textarea-with-voice w-full p-4 rounded-lg h-32" 
                                            placeholder="Any additional information about your vehicle's condition, modifications, or special features... (Click the mic to speak)"
                                        ></textarea>
                                        
                                        <!-- Voice Button -->
                                        <button type="button" id="voiceButton" class="voice-button" title="Click to start voice input">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-.66.54-1.2 1.2-1.2s1.2.54 1.2 1.2l-.01 6.2c0 .66-.53 1.2-1.19 1.2s-1.2-.54-1.2-1.2V4.9zm6.5 6.1c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5.2c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.5z"/>
                                            </svg>
                                        </button>
                                        
                                        <!-- Clear Text Button -->
                                        <button type="button" id="clearTextButton" class="absolute right-16 bottom-3 bg-gray-500 hover:bg-gray-600 border-none rounded-full w-8 h-8 cursor-pointer flex items-center justify-center transition-all text-white" title="Clear repetitive text">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            </svg>
                                        </button>
                                        
                                        <!-- Voice Status Indicator -->
                                        <div id="voiceStatus" class="voice-status">Ready to listen</div>
                                        
                                        <!-- Voice Visualization -->
                                        <div id="voiceVisualization" class="voice-visualization">
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                        </div>
                                        
                                        <!-- Voice Tips -->
                                        <div class="mt-3 text-xs text-gray-500">
                                            <div class="flex items-center gap-4 mb-2">
                                                <span>üí° Tip: Pause 2-3 seconds between sentences for better separation</span>
                                            </div>
                                            <div class="flex items-center gap-4">
                                                <span>üîÑ Use clear button (‚ùå) to fix repetitive text</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Photos & Documents -->
                        <div class="form-step" data-step="3">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Photos & Documents</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Vehicle Photos</label>
                                    <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all">
                                        <div class="text-gray-500 mb-4">
                                            <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <p class="text-lg text-gray-700">Upload vehicle photos</p>
                                            <p class="text-sm text-gray-500">Drag and drop or click to browse</p>
                                            <p class="text-xs text-gray-400 mt-2">Recommended: Front, back, interior, engine bay</p>
                                        </div>
                                        <input type="file" class="hidden" multiple accept="image/*">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Documents</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer">
                                            <div class="text-gray-500">
                                                <svg class="mx-auto h-8 w-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                <p class="text-sm text-gray-700">Vehicle Title</p>
                                            </div>
                                            <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                                        </div>
                                        
                                        <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer">
                                            <div class="text-gray-500">
                                                <svg class="mx-auto h-8 w-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                <p class="text-sm text-gray-700">Registration</p>
                                            </div>
                                            <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Pricing & Contact -->
                        <div class="form-step" data-step="4">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Pricing & Contact Information</h2>
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">ü§ñ AI Estimated Value</h3>
                                    <div id="aiEstimate" class="text-3xl font-bold text-purple-600 mb-2">LKR 4.2L - 5.8L</div>
                                    <p class="text-gray-600 text-sm">Based on Sri Lankan market data, vehicle condition, and mileage</p>
                                    <div class="mt-3 text-xs text-gray-500">
                                        <span>üìä Comparable vehicles: LKR 3.8M - 6.2M</span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="relative">
                                        <label class="floating-label absolute left-3 pointer-events-none">Your Asking Price (LKR)</label>
                                        <input type="number" class="form-input w-full p-4 pt-6 rounded-lg" placeholder="4500000" required>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label active absolute left-3 pointer-events-none">Negotiable?</label>
                                        <select class="custom-select w-full p-4 pt-6 rounded-lg">
                                            <option value="yes">Yes, open to negotiation</option>
                                            <option value="no">No, firm price</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label absolute left-3 pointer-events-none">Your Name</label>
                                        <input type="text" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label absolute left-3 pointer-events-none">Phone Number</label>
                                        <input type="tel" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                    </div>
                                    
                                    <div class="relative md:col-span-2">
                                        <label class="floating-label absolute left-3 pointer-events-none">Email Address</label>
                                        <input type="email" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Preferred Contact Method</label>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                                            <span class="text-gray-700">Phone</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                                            <span class="text-gray-700">Email</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                                            <span class="text-gray-700">Text Message</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between mt-8">
                            <button type="button" id="prevBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors" style="display: none;">Previous</button>
                            <button type="button" id="nextBtn" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition-colors ml-auto">Next</button>
                            <button type="submit" id="submitBtn" class="px-8 py-3 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition-colors ml-auto" style="display: none;">List Vehicle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrated Chatbot -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" id="chatbotToggle">
            <div class="chatbot-help-hint" id="chatbotHint">Need help selling? Ask me! üí¨</div>
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
        </button>
        
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>WheelzAI Assistant üá±üá∞</h3>
                <button class="chatbot-close" id="chatbotClose">&times;</button>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages will be added here dynamically -->
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            
            <div class="chatbot-input-area">
                <div class="chatbot-input-container">
                    <textarea 
                        class="chatbot-input" 
                        id="chatbotInput" 
                        placeholder="Ask about vehicle selling, prices, tips, or anything else..."
                        rows="1"
                    ></textarea>
                    <button class="chatbot-send" id="chatbotSend">
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Enhanced Voice-to-Text Implementation
        class VoiceToText {
            constructor() {
                this.isRecording = false;
                this.recognition = null;
                this.apiKey = '74c9c783d7782439649a9ae883fc54e465a24ee8';
                this.currentTranscript = '';
                this.finalTranscript = '';
                this.interimTranscript = '';
                this.lastProcessedLength = 0;
                
                // Initialize Web Speech API with enhanced settings
                this.initWebSpeechAPI();
                
                // Bind elements
                this.voiceButton = document.getElementById('voiceButton');
                this.textarea = document.getElementById('additionalNotes');
                this.voiceStatus = document.getElementById('voiceStatus');
                this.voiceVisualization = document.getElementById('voiceVisualization');
                
                // Bind events
                this.bindEvents();
            }

            initWebSpeechAPI() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    // Enhanced settings for better sentence separation
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';
                    this.recognition.maxAlternatives = 1; // Reduced to avoid confusion
                    
                    // Try different languages for better recognition
                    const userLang = navigator.language || navigator.userLanguage || 'en-US';
                    if (userLang.startsWith('si')) {
                        this.recognition.lang = 'si-LK'; // Sinhala
                    } else if (userLang.startsWith('ta')) {
                        this.recognition.lang = 'ta-LK'; // Tamil
                    } else {
                        this.recognition.lang = 'en-US'; // Default English
                    }
                    
                    this.recognition.onstart = () => {
                        console.log('üé§ Voice recognition started');
                        this.onRecordingStart();
                    };
                    
                    this.recognition.onresult = (event) => {
                        this.processResults(event);
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('üé§ Voice recognition error:', event.error);
                        this.onRecordingError(event.error);
                    };
                    
                    this.recognition.onend = () => {
                        console.log('üé§ Voice recognition ended');
                        this.onRecordingEnd();
                    };
                    
                    // Add speech detection events for better pause handling
                    this.recognition.onspeechstart = () => {
                        console.log('üé§ Speech detected');
                        this.showStatus('üé§ Speaking detected...', 'recording');
                    };
                    
                    this.recognition.onspeechend = () => {
                        console.log('üé§ Speech ended');
                        this.showStatus('üé§ Processing speech...', 'processing');
                    };
                }
            }

            processResults(event) {
                let interimTranscript = '';
                let newFinalTranscript = '';
                
                // Process all results to separate final from interim
                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript.trim();
                    
                    if (result.isFinal && transcript) {
                        newFinalTranscript += transcript + ' ';
                        console.log(`üé§ Final result ${i}:`, transcript);
                    } else if (transcript) {
                        interimTranscript += transcript + ' ';
                    }
                }
                
                // Process new final text if we have it
                if (newFinalTranscript && newFinalTranscript !== this.finalTranscript) {
                    // Get only the new part that was added
                    const newPart = newFinalTranscript.replace(this.finalTranscript, '').trim();
                    
                    if (newPart) {
                        console.log('üé§ New sentence detected:', newPart);
                        this.finalTranscript = newFinalTranscript;
                        
                        // Clean and add the new sentence
                        const cleanedSentence = this.cleanTranscript(newPart);
                        if (cleanedSentence) {
                            this.addSentenceToTextarea(cleanedSentence);
                            this.showStatus('‚úÖ Sentence added', 'success');
                            
                            // Brief success indication
                            setTimeout(() => {
                                if (this.isRecording) {
                                    this.showStatus('üé§ Listening for next sentence...', 'recording');
                                }
                            }, 1000);
                        }
                    }
                } else if (interimTranscript) {
                    // Show interim results in status
                    this.showStatus(`üé§ ${interimTranscript.slice(0, 30)}...`, 'recording');
                }
            }

            addSentenceToTextarea(newSentence) {
                if (this.textarea && newSentence.trim()) {
                    const currentText = this.textarea.value.trim();
                    let updatedText = '';
                    
                    // Ensure we have a clean sentence
                    let cleanSentence = newSentence.trim();
                    
                    // Capitalize first letter
                    cleanSentence = cleanSentence.charAt(0).toUpperCase() + cleanSentence.slice(1);
                    
                    if (currentText) {
                        // Add proper sentence separation
                        if (currentText.endsWith('.') || currentText.endsWith('!') || currentText.endsWith('?')) {
                            updatedText = currentText + ' ' + cleanSentence;
                        } else {
                            updatedText = currentText + '. ' + cleanSentence;
                        }
                    } else {
                        updatedText = cleanSentence;
                    }
                    
                    // Ensure sentence ends with punctuation
                    if (!updatedText.endsWith('.') && !updatedText.endsWith('!') && !updatedText.endsWith('?')) {
                        updatedText += '.';
                    }
                    
                    // Update textarea
                    this.textarea.value = updatedText;
                    
                    // Trigger input event for any listeners
                    this.textarea.dispatchEvent(new Event('input'));
                    
                    // Scroll to end of textarea
                    this.textarea.scrollTop = this.textarea.scrollHeight;
                    
                    console.log('‚úÖ Added sentence to textarea:', cleanSentence);
                    console.log('üìù Current textarea content:', this.textarea.value);
                }
            }

            updateTextarea() {
                // This method is now replaced by addSentenceToTextarea for better control
                console.log('üé§ Using addSentenceToTextarea instead');
            }

            cleanTranscript(transcript) {
                // Remove repetitive words and clean up the text
                const words = transcript.toLowerCase().split(/\s+/);
                const cleanedWords = [];
                let lastWord = '';
                let repetitionCount = 0;
                
                for (const word of words) {
                    const cleanWord = word.replace(/[^\w\s]/g, '').trim();
                    
                    if (cleanWord === lastWord) {
                        repetitionCount++;
                        // Skip if too many repetitions
                        if (repetitionCount > 2) continue;
                    } else {
                        repetitionCount = 0;
                    }
                    
                    if (cleanWord && cleanWord.length > 1) {
                        cleanedWords.push(cleanWord);
                        lastWord = cleanWord;
                    }
                }
                
                // Capitalize first letter and format properly
                let cleaned = cleanedWords.join(' ');
                cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
                
                // Auto-correct common vehicle terms
                cleaned = this.autoCorrectVehicleTerms(cleaned);
                
                return cleaned;
            }

            autoCorrectVehicleTerms(text) {
                const corrections = {
                    'kar': 'car',
                    'the kar': 'the car',
                    'auto': 'vehicle',
                    'millage': 'mileage',
                    'milage': 'mileage',
                    'servise': 'service',
                    'maintenence': 'maintenance',
                    'accesories': 'accessories',
                    'modifikations': 'modifications',
                    'condishon': 'condition',
                    'exelent': 'excellent',
                    'gud': 'good',
                    'brak': 'brake',
                    'engin': 'engine',
                    'tyres': 'tires',
                    'cluch': 'clutch'
                };
                
                let corrected = text;
                for (const [wrong, right] of Object.entries(corrections)) {
                    const regex = new RegExp(`\\b${wrong}\\b`, 'gi');
                    corrected = corrected.replace(regex, right);
                }
                
                return corrected;
            }

            bindEvents() {
                if (this.voiceButton) {
                    this.voiceButton.addEventListener('click', () => {
                        if (this.isRecording) {
                            this.stopRecording();
                        } else {
                            this.startRecording();
                        }
                    });
                }
            }

            async startRecording() {
                if (this.isRecording) return;
                
                try {
                    // Check for microphone permissions
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        }
                    });
                    stream.getTracks().forEach(track => track.stop());
                    
                    this.isRecording = true;
                    this.finalTranscript = '';
                    this.interimTranscript = '';
                    
                    if (this.recognition) {
                        // Use Web Speech API with enhanced settings
                        this.recognition.start();
                    } else {
                        // Fallback to Google Cloud Speech-to-Text
                        console.warn('Web Speech API not available, falling back to Google Cloud API');
                        this.startGoogleCloudRecording();
                    }
                    
                } catch (error) {
                    console.error('üé§ Microphone access denied:', error);
                    this.showStatus('Microphone access denied. Please allow microphone access and try again.', 'error');
                }
            }

            stopRecording() {
                if (!this.isRecording) return;
                
                this.isRecording = false;
                
                if (this.recognition) {
                    this.recognition.stop();
                } else {
                    this.stopGoogleCloudRecording();
                }
                
                // Final processing
                if (this.finalTranscript) {
                    this.showStatus('Processing final text...', 'processing');
                    setTimeout(() => {
                        this.showStatus('Voice input complete!', 'success');
                        setTimeout(() => this.hideStatus(), 2000);
                    }, 1000);
                }
            }

            onRecordingStart() {
                this.voiceButton.classList.add('recording');
                this.voiceButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                `;
                this.voiceButton.title = 'Click to stop recording';
                
                // Reset tracking variables for a new recording session
                this.finalTranscript = '';
                this.interimTranscript = '';
                
                this.showStatus('üé§ Listening... Speak your first sentence', 'recording');
                this.voiceVisualization.classList.add('active');
                
                console.log('üé§ Recording started - ready for input');
            }

            onRecordingEnd() {
                this.voiceButton.classList.remove('recording', 'processing');
                this.voiceButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-.66.54-1.2 1.2-1.2s1.2.54 1.2 1.2l-.01 6.2c0 .66-.53 1.2-1.19 1.2s-1.2-.54-1.2-1.2V4.9zm6.5 6.1c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5.2c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.5z"/>
                    </svg>
                `;
                this.voiceButton.title = 'Click to start voice input';
                
                this.voiceVisualization.classList.remove('active');
                this.isRecording = false;
                
                // Show completion message
                this.showStatus('Voice input complete!', 'success');
                setTimeout(() => this.hideStatus(), 2000);
                
                console.log('üé§ Recording session ended');
            }

            onRecordingError(error) {
                console.error('Voice recognition error:', error);
                this.onRecordingEnd();
                
                let errorMessage = 'Voice recognition error';
                let suggestions = '';
                
                switch (error) {
                    case 'no-speech':
                        errorMessage = 'No speech detected';
                        suggestions = 'Try speaking louder and clearer';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Microphone not available';
                        suggestions = 'Check your microphone connection';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied';
                        suggestions = 'Allow microphone access in browser settings';
                        break;
                    case 'network':
                        errorMessage = 'Network error occurred';
                        suggestions = 'Check your internet connection';
                        break;
                    case 'service-not-allowed':
                        errorMessage = 'Speech service not allowed';
                        suggestions = 'Try refreshing the page';
                        break;
                    default:
                        errorMessage = `Voice recognition error: ${error}`;
                        suggestions = 'Try speaking more clearly or check your microphone';
                }
                
                this.showStatus(`${errorMessage}. ${suggestions}`, 'error');
            }

            // Enhanced Google Cloud Speech-to-Text implementation
            async startGoogleCloudRecording() {
                try {
                    console.log('üé§ Starting Google Cloud recording...');
                    this.onRecordingStart();
                    
                    // Get audio stream
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 16000
                        }
                    });
                    
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        await this.processAudioWithGoogleCloud(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.mediaRecorder.start(1000); // Collect data every second
                    
                } catch (error) {
                    console.error('Google Cloud recording error:', error);
                    this.onRecordingError('google-cloud-error');
                }
            }

            async processAudioWithGoogleCloud(audioBlob) {
                try {
                    this.showStatus('Processing with Google Cloud...', 'processing');
                    
                    // Convert audio to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    
                    reader.onload = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        
                        // This would require a server-side proxy to handle the actual Google Cloud API call
                        // For now, we'll simulate the response
                        setTimeout(() => {
                            const simulatedTranscript = "This vehicle is in excellent condition with regular maintenance and no accidents.";
                            this.finalTranscript = simulatedTranscript;
                            this.updateTextarea();
                            this.onRecordingEnd();
                        }, 2000);
                    };
                    
                } catch (error) {
                    console.error('Google Cloud processing error:', error);
                    this.onRecordingError('processing-error');
                }
            }

            stopGoogleCloudRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                    this.mediaRecorder.stop();
                }
            }

            showStatus(message, type = 'info') {
                if (!this.voiceStatus) return;
                
                this.voiceStatus.textContent = message;
                this.voiceStatus.classList.remove('visible');
                
                // Add color based on type
                switch (type) {
                    case 'recording':
                        this.voiceStatus.style.background = 'rgba(239, 68, 68, 0.9)';
                        this.voiceStatus.style.color = 'white';
                        break;
                    case 'processing':
                        this.voiceStatus.style.background = 'rgba(245, 158, 11, 0.9)';
                        this.voiceStatus.style.color = 'white';
                        break;
                    case 'success':
                        this.voiceStatus.style.background = 'rgba(34, 197, 94, 0.9)';
                        this.voiceStatus.style.color = 'white';
                        break;
                    case 'error':
                        this.voiceStatus.style.background = 'rgba(220, 38, 38, 0.9)';
                        this.voiceStatus.style.color = 'white';
                        break;
                    default:
                        this.voiceStatus.style.background = 'rgba(0, 0, 0, 0.8)';
                        this.voiceStatus.style.color = 'white';
                }
                
                // Force reflow and show
                setTimeout(() => {
                    this.voiceStatus.classList.add('visible');
                }, 10);
                
                // Auto-hide after delay (longer for errors)
                if (type !== 'recording') {
                    const delay = type === 'error' ? 5000 : 3000;
                    setTimeout(() => {
                        this.hideStatus();
                    }, delay);
                }
            }

            hideStatus() {
                if (this.voiceStatus) {
                    this.voiceStatus.classList.remove('visible');
                }
            }

            // Method to clear repetitive text manually
            clearRepetitiveText() {
                if (this.textarea) {
                    const currentText = this.textarea.value;
                    const cleaned = this.cleanTranscript(currentText);
                    this.textarea.value = cleaned;
                    this.textarea.dispatchEvent(new Event('input'));
                    
                    // Show feedback
                    this.showStatus('Text cleaned successfully!', 'success');
                    setTimeout(() => this.hideStatus(), 2000);
                }
            }
            
            // Add debugging method to test textarea updates
            testTextareaUpdate() {
                console.log('üß™ Testing textarea update...');
                if (this.textarea) {
                    this.textarea.value = 'Test sentence added successfully.';
                    this.textarea.dispatchEvent(new Event('input'));
                    console.log('‚úÖ Test completed - textarea value:', this.textarea.value);
                } else {
                    console.error('‚ùå Textarea not found!');
                }
            }
        }

        // Enhanced WheelzAI Chatbot (keeping all existing code)
        class EnhancedWheelzAIChatbot {
            constructor() {
                this.isOpen = false;
                this.messages = [];
                this.conversationHistory = [];
                this.hasShownWelcome = false;
                
                // Replace with your actual Gemini API key
                this.GEMINI_API_KEY = 'AIzaSyCLW0c2OF0frOyKJtNnRMDH7WrByySs2Ww';
                
                // Enhanced predefined questions for selling page
                this.predefinedQA = {
                    "How to sell my vehicle on WheelzAI": "**Steps to sell your vehicle on WheelzAI:**\n\n1. **Fill Basic Information** - Select make, model, year, mileage, body type, and fuel type\n2. **Describe Condition** - Choose excellent/good/fair and provide accident history\n3. **Upload Photos** - Add clear photos from multiple angles (front, back, interior, engine bay)\n4. **Set Price & Contact** - Use our AI estimate as guidance and provide contact details\n\n**Pro Tips:**\n‚Ä¢ Clean your car before taking photos\n‚Ä¢ Be honest about vehicle condition\n‚Ä¢ Set competitive pricing based on AI estimate\n‚Ä¢ Respond quickly to buyer inquiries",
                    
                    "Best practices for vehicle photos": "**Photo Guidelines for Maximum Sales:**\n\nüì∏ **Required Photos:**\n‚Ä¢ Front view (clean background)\n‚Ä¢ Rear view\n‚Ä¢ Both side views\n‚Ä¢ Interior (dashboard, seats)\n‚Ä¢ Engine bay\n‚Ä¢ Odometer reading\n\nüì∏ **Photo Tips:**\n‚Ä¢ Take photos in good lighting (daylight preferred)\n‚Ä¢ Clean the vehicle thoroughly first\n‚Ä¢ Use a plain background\n‚Ä¢ Avoid reflections and shadows\n‚Ä¢ Show any damage honestly\n‚Ä¢ Include close-ups of special features\n\n**Result:** Quality photos can increase inquiries by 70%!",
                    
                    "How to price my vehicle competitively": "**Pricing Strategy for Sri Lankan Market:**\n\nüí∞ **Use Our AI Estimate:**\n‚Ä¢ Our system considers: make, model, year, mileage, condition\n‚Ä¢ Based on current Sri Lankan market data\n‚Ä¢ Provides realistic price range\n\nüí∞ **Pricing Tips:**\n‚Ä¢ Start at the higher end of AI estimate\n‚Ä¢ Leave room for negotiation (10-15%)\n‚Ä¢ Check similar vehicles online\n‚Ä¢ Consider vehicle condition honestly\n‚Ä¢ Factor in service history and modifications\n\nüí∞ **Quick Pricing Guide:**\n‚Ä¢ Excellent condition: Use upper AI estimate\n‚Ä¢ Good condition: Use middle range\n‚Ä¢ Fair condition: Use lower estimate\n\n**Remember:** Overpricing delays sales, underpricing loses money!",
                    
                    "What documents do I need to sell": "**Required Documents for Vehicle Sale in Sri Lanka:**\n\nüìã **Essential Documents:**\n‚Ä¢ **Vehicle Registration Book** - Must be in your name\n‚Ä¢ **Revenue License** - Current and valid\n‚Ä¢ **Insurance Certificate** - Up to date\n‚Ä¢ **Emission Test Certificate** - For vehicles over 3 years\n‚Ä¢ **Service Records** - Increases buyer confidence\n\nüìã **Additional Helpful Documents:**\n‚Ä¢ Purchase receipts for major repairs\n‚Ä¢ Warranty documents (if applicable)\n‚Ä¢ Import documents (for imported vehicles)\n‚Ä¢ Previous accident reports (if any)\n\nüìã **Transfer Process:**\n‚Ä¢ Original owner must sign transfer documents\n‚Ä¢ Buyer pays transfer fees at DMT\n‚Ä¢ New registration issued to buyer\n\n**Tip:** Having all documents ready speeds up the sale process!",
                    
                    "How to handle buyer inquiries": "**Professional Buyer Communication:**\n\nüìû **Response Guidelines:**\n‚Ä¢ Respond within 2-4 hours maximum\n‚Ä¢ Be professional and friendly\n‚Ä¢ Answer questions honestly\n‚Ä¢ Provide additional photos if requested\n\nüìû **Common Questions to Prepare For:**\n‚Ä¢ \"Why are you selling?\"\n‚Ä¢ \"Any accidents or major repairs?\"\n‚Ä¢ \"Can I see service records?\"\n‚Ä¢ \"Is the price negotiable?\"\n‚Ä¢ \"Can I bring a mechanic for inspection?\"\n\nüìû **Safety Tips:**\n‚Ä¢ Meet in public places for viewings\n‚Ä¢ Allow test drives with valid license only\n‚Ä¢ Don't share personal financial information\n‚Ä¢ Trust your instincts about buyers\n\n**Result:** Professional communication builds trust and closes sales faster!",
                    
                    "Sri Lankan vehicle market trends 2025": "**Current Sri Lankan Vehicle Market (2025):**\n\nüìà **Popular Categories:**\n‚Ä¢ **Hybrid vehicles** - High demand, good resale\n‚Ä¢ **Compact cars** - Perfect for city driving\n‚Ä¢ **SUVs** - Growing family preference\n‚Ä¢ **Electric vehicles** - Emerging market\n\nüìà **Price Trends:**\n‚Ä¢ Hybrid premiums: 15-25% above petrol\n‚Ä¢ Japanese brands maintain strong value\n‚Ä¢ Older vehicles (10+ years) depreciating faster\n‚Ä¢ Well-maintained vehicles hold value better\n\nüìà **Best Time to Sell:**\n‚Ä¢ January-March: High demand (bonus season)\n‚Ä¢ Avoid December (holiday season)\n‚Ä¢ Weekends get more inquiries\n\n**Market Insight:** Clean, documented vehicles sell 40% faster than average!"
                };
                
                this.quickQuestions = Object.keys(this.predefinedQA);
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkAPIStatus();
                this.showInitialHint();
            }

            showInitialHint() {
                // Show help hint after 3 seconds
                setTimeout(() => {
                    const hint = document.getElementById('chatbotHint');
                    if (hint) {
                        hint.style.animation = 'fadeInOut 4s ease-in-out';
                    }
                }, 3000);
            }

            checkAPIStatus() {
                if (this.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    console.warn('Gemini API key not configured. Using offline mode only.');
                }
            }

            bindEvents() {
                const toggle = document.getElementById('chatbotToggle');
                const close = document.getElementById('chatbotClose');
                const send = document.getElementById('chatbotSend');
                const input = document.getElementById('chatbotInput');

                if (toggle) toggle.addEventListener('click', () => this.toggleChat());
                if (close) close.addEventListener('click', () => this.closeChat());
                if (send) send.addEventListener('click', () => this.sendMessage());
                
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    // Auto-resize textarea
                    input.addEventListener('input', () => {
                        input.style.height = 'auto';
                        input.style.height = Math.min(input.scrollHeight, 100) + 'px';
                    });
                }
            }

            toggleChat() {
                const window = document.getElementById('chatbotWindow');
                if (!window) return;
                
                this.isOpen = !this.isOpen;
                
                if (this.isOpen) {
                    window.classList.add('active');
                    const input = document.getElementById('chatbotInput');
                    if (input) input.focus();
                    
                    // Show welcome message only when first opened
                    if (!this.hasShownWelcome) {
                        setTimeout(() => {
                            this.addWelcomeMessage();
                            this.hasShownWelcome = true;
                        }, 300);
                    }
                } else {
                    window.classList.remove('active');
                }
            }

            closeChat() {
                const window = document.getElementById('chatbotWindow');
                if (window) {
                    window.classList.remove('active');
                    this.isOpen = false;
                }
            }

            addWelcomeMessage() {
                const welcomeMsg = "Ayubowan! Welcome to WheelzAI Selling Assistant! üá±üá∞üöó\n\nI'm here to help you sell your vehicle successfully! I can assist with:\n\n‚Ä¢ Pricing guidance and market insights\n‚Ä¢ Photo tips for better listings\n‚Ä¢ Document requirements\n‚Ä¢ Buyer communication strategies\n‚Ä¢ Current market trends\n\nChoose a quick question below or ask me anything about selling your vehicle:";
                this.addMessage('bot', welcomeMsg);
                
                // Add selling page context
                setTimeout(() => {
                    this.addContextMessage();
                }, 500);
                
                // Add questions immediately after welcome message
                setTimeout(() => {
                    this.addQuickQuestions();
                }, 100);
            }

            addContextMessage() {
                const contextMsg = "üí° **Selling Page Context:**\nI can see you're on the vehicle selling form. I can help you with:\n‚Ä¢ Understanding each step of the form\n‚Ä¢ Tips for each section you're filling out\n‚Ä¢ Pricing guidance based on your vehicle details\n‚Ä¢ Best practices for photos and descriptions";
                this.addMessage('bot', contextMsg);
            }

            addMessage(sender, text, isHtml = false) {
                const messagesContainer = document.getElementById('chatbotMessages');
                if (!messagesContainer) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                if (isHtml) {
                    messageDiv.innerHTML = text;
                } else {
                    messageDiv.textContent = text;
                }
                
                this.messages.push({ sender, text, timestamp: new Date() });
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            addQuickQuestions() {
                const messagesContainer = document.getElementById('chatbotMessages');
                
                if (!messagesContainer) {
                    console.error('Messages container not found');
                    return;
                }
                
                const questionsContainer = document.createElement('div');
                questionsContainer.className = 'quick-questions';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'quick-questions-header';
                headerDiv.textContent = 'üí° Quick Help - Click any question:';
                questionsContainer.appendChild(headerDiv);
                
                this.quickQuestions.forEach((question, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-question';
                    btn.textContent = `${index + 1}. ${question}`;
                    
                    btn.addEventListener('click', () => {
                        this.handleQuickQuestion(question);
                    });
                    
                    questionsContainer.appendChild(btn);
                });
                
                messagesContainer.appendChild(questionsContainer);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            handleQuickQuestion(question) {
                this.addMessage('user', question);
                this.showTypingIndicator();
                
                setTimeout(() => {
                    this.hideTypingIndicator();
                    const answer = this.predefinedQA[question];
                    this.addMessage('bot', answer);
                }, 1000);
            }

            showTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                const messagesContainer = document.getElementById('chatbotMessages');
                if (indicator && messagesContainer) {
                    indicator.style.display = 'flex';
                    messagesContainer.appendChild(indicator);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            async sendMessage() {
                const input = document.getElementById('chatbotInput');
                const sendButton = document.getElementById('chatbotSend');
                if (!input) return;

                const message = input.value.trim();
                if (!message) return;
                
                if (sendButton) sendButton.disabled = true;
                input.disabled = true;
                
                this.addMessage('user', message);
                this.conversationHistory.push({ role: "user", content: message });
                
                input.value = '';
                input.style.height = 'auto';
                
                this.showTypingIndicator();
                
                try {
                    const response = await this.getGeminiResponse(message);
                    this.hideTypingIndicator();
                    this.addMessage('bot', response + " <span class='gemini-badge'>Gemini</span>", true);
                    this.conversationHistory.push({ role: "assistant", content: response });
                } catch (error) {
                    console.error('Gemini API error:', error);
                    this.hideTypingIndicator();
                    
                    const fallbackResponse = this.getEnhancedResponse(message);
                    this.addMessage('bot', fallbackResponse);
                    
                    if (this.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                        this.addErrorMessage("API key not configured. Using offline responses.");
                    } else {
                        this.addErrorMessage("Gemini API temporarily unavailable. Using offline responses.");
                    }
                }
                
                if (sendButton) sendButton.disabled = false;
                input.disabled = false;
                input.focus();
            }

            async getGeminiResponse(message) {
                if (this.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    throw new Error('API key not configured');
                }

                // Get current form context
                const formContext = this.getFormContext();

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are WheelzAI Selling Assistant, specifically helping users sell vehicles in Sri Lanka. 

Current context: User is on the vehicle selling form page. Current form data: ${formContext}

You specialize in:
- Vehicle selling process in Sri Lanka
- Pricing strategies and market insights
- Photography tips for vehicle listings
- Document requirements for vehicle sales
- Buyer communication and negotiation
- Sri Lankan vehicle market trends
- Platform-specific guidance for WheelzAI

Key market data for Sri Lanka 2025:
- Toyota Vitz: LKR 5.5-6M (popular compact)
- Honda Fit: LKR 5.5-5.8M (hybrid available)  
- Suzuki Swift: LKR 5.5-5.8M (sporty choice)
- Toyota Vios: LKR 5.2-5.7M (sedan option)
- Toyota Aqua: LKR 6-8.5M (hybrid premium)
- Honda Grace: LKR 6.5-8.5M (luxury hybrid)

Current selling context: The user is filling out a multi-step form with:
Step 1: Basic vehicle information
Step 2: Vehicle condition assessment (with voice input for notes)
Step 3: Photos and documents upload
Step 4: Pricing and contact information

User question: ${message}

Please provide helpful, specific advice for selling vehicles in Sri Lanka. Keep responses under 200 words and actionable.`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 300,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Gemini API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Invalid response format from Gemini API');
                }
            }

            getFormContext() {
                // Extract current form data to provide context to AI
                const makeSelect = document.querySelector('select[required]');
                const modelInput = document.querySelector('input[required]');
                const yearSelect = document.querySelectorAll('select[required]')[1];
                const mileageInput = document.querySelector('input[type="number"]');
                const currentStep = document.querySelector('.form-step.active')?.getAttribute('data-step') || '1';
                
                return `Step ${currentStep}/4, Make: ${makeSelect?.value || 'not selected'}, Model: ${modelInput?.value || 'not entered'}, Year: ${yearSelect?.value || 'not selected'}, Mileage: ${mileageInput?.value || 'not entered'}`;
            }

            getEnhancedResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Check for exact matches with predefined questions
                for (const [question, answer] of Object.entries(this.predefinedQA)) {
                    if (lowerMessage.includes(question.toLowerCase().substring(0, 15))) {
                        return answer;
                    }
                }
                
                // Voice input help
                if (lowerMessage.includes('voice') || lowerMessage.includes('microphone') || lowerMessage.includes('speak')) {
                    return "**Voice Input Feature:**\n\nüé§ **How to use voice input:**\n‚Ä¢ Navigate to Step 2 (Vehicle Condition)\n‚Ä¢ Find the 'Additional Notes' section\n‚Ä¢ Click the microphone button in the textarea\n‚Ä¢ Speak clearly about your vehicle's condition\n‚Ä¢ Click the button again to stop recording\n\nüé§ **Voice Tips:**\n‚Ä¢ Speak in a quiet environment\n‚Ä¢ Allow microphone access when prompted\n‚Ä¢ Describe modifications, special features, or condition details\n‚Ä¢ Your speech will be automatically converted to text\n\n**Perfect for:** Detailed condition descriptions, modifications, service history, or any special features!";
                }
                
                // Form-specific help
                if (lowerMessage.includes('step') || lowerMessage.includes('form') || lowerMessage.includes('fill')) {
                    return "**Form Help:**\n\nüìù **Current Steps:**\n1. **Basic Info** - Make, model, year, mileage, body type, fuel type\n2. **Condition** - Overall condition, accident history, service records (üé§ Voice input available!)\n3. **Photos** - Vehicle photos and documents (title, registration)\n4. **Pricing** - Set asking price and contact information\n\nüí° **Tips:**\n‚Ä¢ Fill all required fields (marked with *)\n‚Ä¢ Be accurate with vehicle details\n‚Ä¢ Use voice input for detailed condition notes\n‚Ä¢ Our AI will estimate value in Step 4\n‚Ä¢ Upload clear, well-lit photos\n\nWhich step do you need help with?";
                }
                
                // Default response with voice feature mention
                return "I'm here to help you sell your vehicle successfully! Here's what I can assist with:\n\nüöó **Form Help:** \"How to fill Step 2\" or \"What's required in each step\"\nüí∞ **Pricing:** \"How to price my car\" or \"AI estimate explained\"\nüé§ **Voice Input:** \"How to use voice input\" for hands-free note taking\nüì∏ **Photos:** \"Best photo tips\" or \"What photos to take\"\nüìã **Documents:** \"What documents needed\" or \"Transfer process\"\nüë• **Buyers:** \"Handle inquiries\" or \"Negotiation tips\"\nüìä **Market:** \"Current trends\" or \"Best time to sell\"\n\nWhat specific aspect of selling would you like help with?";
            }

            addErrorMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                if (!messagesContainer) return;
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                messagesContainer.appendChild(errorDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Original form functionality (keeping ALL existing code)
        let currentStep = 1;
        const totalSteps = 4;

        // Elements
        const steps = document.querySelectorAll('.form-step');
        const stepIndicators = document.querySelectorAll('.step-indicator');
        const progressBar = document.getElementById('progressBar');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        // API Configuration
        const API_BASE_URL = 'http://localhost:5000'; // Your Flask API URL

        // Enhanced LKR formatting function
        function formatLKR(amount) {
            if (amount >= 1000000000) {
                return `${(amount / 1000000000).toFixed(1)} Billion`;
            } else if (amount >= 10000000) {
                return `${(amount / 10000000).toFixed(1)} Crore`;
            } else if (amount >= 1000000) {
                return `${(amount / 1000000).toFixed(1)} Million`;
            } else if (amount >= 100000) {
                return `${(amount / 100000).toFixed(1)} Lakh`;
            } else {
                return amount.toLocaleString();
            }
        }

        // Vehicle valuation data for Sri Lankan market (in LKR) - Fallback data
        const vehicleData = {
            toyota: {
                vios: { base: 4500000, yearDepreciation: 200000, mileageDepreciation: 15 },
                corolla: { base: 6500000, yearDepreciation: 300000, mileageDepreciation: 20 },
                camry: { base: 12000000, yearDepreciation: 500000, mileageDepreciation: 25 },
                prius: { base: 7500000, yearDepreciation: 350000, mileageDepreciation: 18 },
                aqua: { base: 8000000, yearDepreciation: 300000, mileageDepreciation: 16 }
            },
            honda: {
                civic: { base: 8500000, yearDepreciation: 400000, mileageDepreciation: 22 },
                fit: { base: 5500000, yearDepreciation: 250000, mileageDepreciation: 16 },
                accord: { base: 15000000, yearDepreciation: 600000, mileageDepreciation: 28 },
                city: { base: 6000000, yearDepreciation: 280000, mileageDepreciation: 18 },
                grace: { base: 6200000, yearDepreciation: 270000, mileageDepreciation: 17 }
            },
            nissan: {
                march: { base: 4200000, yearDepreciation: 180000, mileageDepreciation: 14 },
                sunny: { base: 5800000, yearDepreciation: 260000, mileageDepreciation: 17 },
                teana: { base: 8500000, yearDepreciation: 400000, mileageDepreciation: 24 },
                leaf: { base: 7200000, yearDepreciation: 300000, mileageDepreciation: 15 }
            },
            suzuki: {
                swift: { base: 4800000, yearDepreciation: 200000, mileageDepreciation: 15 },
                wagon_r: { base: 3800000, yearDepreciation: 170000, mileageDepreciation: 13 },
                alto: { base: 3200000, yearDepreciation: 150000, mileageDepreciation: 12 }
            },
            bmw: {
                "3series": { base: 18000000, yearDepreciation: 800000, mileageDepreciation: 35 },
                "5series": { base: 25000000, yearDepreciation: 1200000, mileageDepreciation: 45 }
            },
            mercedes: {
                "c-class": { base: 20000000, yearDepreciation: 900000, mileageDepreciation: 38 },
                "e-class": { base: 30000000, yearDepreciation: 1400000, mileageDepreciation: 50 }
            }
        };

        // Function to populate year dropdown dynamically
        function populateYearDropdown() {
            const yearSelect = document.querySelectorAll('select[required]')[1];
            
            if (yearSelect && yearSelect.querySelector('option[value=""]')) {
                const placeholder = yearSelect.querySelector('option[value=""]');
                yearSelect.innerHTML = '';
                yearSelect.appendChild(placeholder);
                
                const currentYear = new Date().getFullYear();
                const startYear = 1990;
                const endYear = Math.max(currentYear + 1, 2025);
                
                for (let year = endYear; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
                
                console.log(`Year dropdown populated with years ${startYear}-${endYear}`);
            }
        }

        // Enhanced AI estimate calculation using API
        async function calculateAIEstimate() {
            const makeSelect = document.querySelector('select[required]');
            const modelInput = document.querySelector('input[required]');
            const yearSelect = document.querySelectorAll('select[required]')[1];
            const mileageInput = document.querySelector('input[type="number"]');
            const bodyTypeSelect = document.querySelectorAll('select[required]')[2];
            const fuelTypeSelect = document.querySelectorAll('select[required]')[3];
            
            if (!makeSelect.value || !modelInput.value || !yearSelect.value || 
                !mileageInput.value || !bodyTypeSelect.value || !fuelTypeSelect.value) {
                return;
            }
            
            const aiEstimateElement = document.getElementById('aiEstimate');
            const confidenceElement = document.querySelector('.text-gray-600.text-sm');
            const comparableElement = document.querySelector('.text-xs.text-gray-500 span');
            
            if (aiEstimateElement) {
                aiEstimateElement.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                        <span>Calculating...</span>
                    </div>
                `;
            }
            
            try {
                const selectedCondition = document.querySelector('input[name="condition"]:checked');
                const condition = selectedCondition ? selectedCondition.value : 'good';
                
                const requestData = {
                    make: makeSelect.value,
                    model: modelInput.value,
                    year: parseInt(yearSelect.value),
                    mileage: parseInt(mileageInput.value),
                    fuel_type: fuelTypeSelect.value,
                    body_type: bodyTypeSelect.value,
                    condition: condition,
                    engine_size: 1500,
                    transmission: 'automatic'
                };
                
                console.log('Sending API request:', requestData);
                
                const response = await fetch(`${API_BASE_URL}/predict-price`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API response:', data);
                
                if (data.success && data.prediction) {
                    const prediction = data.prediction;
                    const marketAnalysis = data.market_analysis;
                    
                    const lowerBound = prediction.price_range.lower;
                    const upperBound = prediction.price_range.upper;
                    
                    if (aiEstimateElement) {
                        aiEstimateElement.innerHTML = `LKR ${formatLKR(lowerBound)} - ${formatLKR(upperBound)}`;
                    }
                    
                    if (confidenceElement) {
                        confidenceElement.innerHTML = `
                            Based on Sri Lankan market data, vehicle condition, and mileage
                            <br><strong>Confidence:</strong> ${prediction.confidence_level || 'High'}
                            ${marketAnalysis.market_data_available ? 
                                `<br><strong>Market Status:</strong> ${marketAnalysis.demand_status || 'Market data available'}` : 
                                '<br><strong>Market Status:</strong> General market estimation'
                            }
                        `;
                    }
                    
                    if (comparableElement && marketAnalysis.market_data_available) {
                        const basePrice = marketAnalysis.current_market_value;
                        if (basePrice) {
                            const basePriceFormatted = basePrice.replace(/LKR\s/, '');
                            comparableElement.innerHTML = `üìä Market base value: ${basePriceFormatted} | Trend: ${marketAnalysis.market_trend || 'Stable'}`;
                        }
                    }
                    
                    addPredictionBreakdown(data);
                    
                } else {
                    throw new Error(data.message || 'Failed to get price prediction');
                }
                
            } catch (error) {
                console.error('API request failed:', error);
                calculateBasicEstimate();
                
                if (confidenceElement) {
                    confidenceElement.innerHTML = `
                        Using basic market calculation (API unavailable)
                        <br><small class="text-orange-600">For accurate pricing, please ensure API is running</small>
                    `;
                }
            }
        }

        // Fallback basic calculation
        function calculateBasicEstimate() {
            const makeSelect = document.querySelector('select[required]');
            const modelInput = document.querySelector('input[required]');
            const yearSelect = document.querySelectorAll('select[required]')[1];
            const mileageInput = document.querySelector('input[type="number"]');
            
            if (!makeSelect.value || !modelInput.value || !yearSelect.value || !mileageInput.value) {
                return;
            }
            
            const make = makeSelect.value.toLowerCase();
            const model = modelInput.value.toLowerCase().replace(/\s+/g, '').replace('-', '');
            const year = parseInt(yearSelect.value);
            const mileage = parseInt(mileageInput.value);
            const currentYear = new Date().getFullYear();
            
            let conditionMultiplier = 1.0;
            const selectedCondition = document.querySelector('input[name="condition"]:checked');
            if (selectedCondition) {
                switch(selectedCondition.value) {
                    case 'excellent': conditionMultiplier = 1.15; break;
                    case 'good': conditionMultiplier = 1.0; break;
                    case 'fair': conditionMultiplier = 0.85; break;
                }
            }
            
            let basePrice = 5000000;
            let yearDepreciation = 250000;
            let mileageDepreciation = 20;
            
            if (vehicleData[make]) {
                const exactMatch = Object.keys(vehicleData[make]).find(key => 
                    model.includes(key) || key.includes(model)
                );
                
                if (exactMatch) {
                    const vehicleInfo = vehicleData[make][exactMatch];
                    basePrice = vehicleInfo.base;
                    yearDepreciation = vehicleInfo.yearDepreciation;
                    mileageDepreciation = vehicleInfo.mileageDepreciation;
                } else {
                    const makeModels = Object.values(vehicleData[make]);
                    basePrice = makeModels.reduce((sum, model) => sum + model.base, 0) / makeModels.length;
                    yearDepreciation = makeModels.reduce((sum, model) => sum + model.yearDepreciation, 0) / makeModels.length;
                    mileageDepreciation = makeModels.reduce((sum, model) => sum + model.mileageDepreciation, 0) / makeModels.length;
                }
            }
            
            const ageDepreciation = (currentYear - year) * yearDepreciation * 0.8;
            const mileageDepreciationAmount = (mileage / 1000) * mileageDepreciation * 0.7;
            
            let estimatedValue = basePrice - ageDepreciation - mileageDepreciationAmount;
            estimatedValue *= conditionMultiplier;
            estimatedValue = Math.max(estimatedValue, 1000000);
            
            const lowerBound = Math.round(estimatedValue * 0.85);
            const upperBound = Math.round(estimatedValue * 1.15);
            
            const aiEstimateElement = document.getElementById('aiEstimate');
            if (aiEstimateElement) {
                aiEstimateElement.innerHTML = `LKR ${formatLKR(lowerBound)} - ${formatLKR(upperBound)}`;
            }
        }

        function addPredictionBreakdown(apiData) {
            const breakdown = apiData.prediction.individual_predictions;
            if (!breakdown) return;
            
            const aiEstimateContainer = document.querySelector('.bg-gradient-to-r.from-purple-50.to-blue-50');
            if (!aiEstimateContainer) return;
            
            if (aiEstimateContainer.querySelector('.prediction-breakdown')) return;
            
            const breakdownHtml = `
                <div class="prediction-breakdown mt-4 p-3 bg-white bg-opacity-50 rounded-lg border border-purple-200">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">üîç AI Model Breakdown:</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        ${Object.entries(breakdown).map(([model, price]) => 
                            `<div class="flex justify-between">
                                <span class="text-gray-600">${model.toUpperCase()}:</span>
                                <span class="font-medium">${price}</span>
                            </div>`
                        ).join('')}
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Final estimate uses weighted ensemble of multiple ML models
                    </div>
                </div>
            `;
            
            aiEstimateContainer.insertAdjacentHTML('beforeend', breakdownHtml);
        }

        // Enhanced form submission with API validation
        async function submitFormWithAPI() {
            const formData = collectFormData();
            
            try {
                const validationResponse = await fetch(`${API_BASE_URL}/validate-vehicle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        make: formData.make,
                        model: formData.model
                    })
                });
                
                if (validationResponse.ok) {
                    const validationData = await validationResponse.json();
                    console.log('Vehicle validation:', validationData);
                    formData.vehicleValidation = validationData;
                }
                
                const finalPrediction = await fetch(`${API_BASE_URL}/predict-price`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        make: formData.make,
                        model: formData.model,
                        year: formData.year,
                        mileage: formData.mileage,
                        fuel_type: formData.fuelType,
                        body_type: formData.bodyType,
                        condition: formData.condition,
                        transmission: 'automatic',
                        accident_history: formData.accidentHistory || 'none',
                        service_records: formData.serviceHistory || 'complete'
                    })
                });
                
                if (finalPrediction.ok) {
                    const predictionData = await finalPrediction.json();
                    formData.aiPrediction = predictionData;
                    formData.aiEstimate = `LKR ${formatLKR(predictionData.prediction.price_range.lower)} - ${formatLKR(predictionData.prediction.price_range.upper)}`;
                }
                
            } catch (error) {
                console.warn('API validation/prediction failed, proceeding with basic data:', error);
            }
            
            return formData;
        }

        // Floating label functionality
        document.querySelectorAll('input, select, textarea').forEach(element => {
            const label = element.parentElement.querySelector('.floating-label');
            
            if (label) {
                function updateLabel() {
                    if (element.value || element.tagName === 'SELECT') {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                }
                
                element.addEventListener('focus', () => label.classList.add('active'));
                element.addEventListener('blur', updateLabel);
                element.addEventListener('input', () => {
                    updateLabel();
                    if (element.required || element.name === 'condition' || element.type === 'number') {
                        setTimeout(calculateAIEstimate, 500);
                    }
                });
                
                updateLabel();
            }
        });

        // Condition selection
        document.querySelectorAll('input[name="condition"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.condition-card').forEach(card => {
                    card.classList.remove('bg-purple-100', 'border-purple-400', 'text-purple-800');
                    card.classList.add('text-gray-800', 'border-gray-200');
                });
                
                if (this.checked) {
                    const card = this.parentElement.querySelector('.condition-card');
                    card.classList.remove('text-gray-800', 'border-gray-200');
                    card.classList.add('bg-purple-100', 'border-purple-400', 'text-purple-800');
                    setTimeout(calculateAIEstimate, 300);
                }
            });
        });

        // File upload functionality with Firebase Storage
        let uploadedFiles = {
            vehiclePhotos: [],
            documents: {
                title: null,
                registration: null
            }
        };

        document.querySelectorAll('.upload-area').forEach(area => {
            const input = area.querySelector('input[type="file"]');
            
            if (input) {
                area.addEventListener('click', () => input.click());
                
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });
                
                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    input.files = e.dataTransfer.files;
                    handleFileSelection(area, input.files, input);
                });
                
                input.addEventListener('change', () => {
                    handleFileSelection(area, input.files, input);
                });
            }
        });

        function handleFileSelection(area, files, inputElement) {
            if (files.length > 0) {
                const fileList = Array.from(files).map(file => file.name).join(', ');
                const multiple = inputElement && inputElement.multiple;
                const accept = inputElement && inputElement.accept;
                
                if (multiple) {
                    uploadedFiles.vehiclePhotos = Array.from(files);
                } else {
                    const docType = area.closest('.grid') ? 
                        (area === area.closest('.grid').children[0] ? 'title' : 'registration') : 'title';
                    uploadedFiles.documents[docType] = files[0];
                }
                
                area.innerHTML = `
                    <div class="text-gray-700">
                        <svg class="mx-auto h-8 w-8 mb-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <p class="text-sm font-medium">${files.length} file(s) selected</p>
                        <p class="text-xs text-gray-500">${fileList}</p>
                    </div>
                    <input type="file" class="hidden" ${multiple ? 'multiple' : ''} accept="${accept || ''}">
                `;
            }
        }

        async function uploadFilesToStorage(files, folder, listingId) {
            console.log(`üîÑ Starting upload for ${files.length} files to folder: ${folder}, listingId: ${listingId}`);
            
            const uploadPromises = files.map(async (file, index) => {
                if (!file) {
                    console.log(`‚ö†Ô∏è File ${index} is null, skipping...`);
                    return null;
                }
                
                const timestamp = Date.now();
                const fileExtension = file.name.split('.').pop();
                const fileName = `vehicles/${listingId}/${folder}/${timestamp}_${index}.${fileExtension}`;
                
                console.log(`üìÅ Uploading file: ${file.name}`);
                console.log(`üìç Storage path: ${fileName}`);
                
                const storageRef = window.ref(window.storage, fileName);
                
                try {
                    console.log(`‚¨ÜÔ∏è Starting upload for ${file.name}...`);
                    const snapshot = await window.uploadBytes(storageRef, file);
                    console.log(`‚úÖ Upload completed for ${file.name}`);
                    
                    const downloadURL = await window.getDownloadURL(snapshot.ref);
                    console.log(`üîó Download URL: ${downloadURL}`);
                    
                    return downloadURL;
                } catch (error) {
                    console.error(`‚ùå Upload failed for ${file.name}:`, error);
                    return null;
                }
            });
            
            const results = await Promise.all(uploadPromises);
            console.log(`üéØ Upload results:`, results);
            return results;
        }

        function collectFormData() {
            const currentUser = window.getCurrentUser();
            
            return {
                userId: currentUser?.uid || null,
                userEmail: currentUser?.email || null,
                userName: currentUser?.displayName || null,
                
                make: document.querySelector('select[required]').value,
                model: document.querySelector('input[required]').value,
                year: parseInt(document.querySelectorAll('select[required]')[1].value),
                mileage: parseInt(document.querySelector('input[type="number"]').value),
                bodyType: document.querySelectorAll('select[required]')[2].value,
                fuelType: document.querySelectorAll('select[required]')[3].value,
                
                condition: document.querySelector('input[name="condition"]:checked')?.value || '',
                accidentHistory: document.querySelectorAll('select')[4].value,
                serviceHistory: document.querySelectorAll('select')[5].value,
                additionalNotes: document.getElementById('additionalNotes').value, // Now includes voice input
                
                askingPrice: parseInt(document.querySelector('input[placeholder="4500000"]').value),
                negotiable: document.querySelectorAll('select')[6].value === 'yes',
                sellerName: document.querySelectorAll('input[required]')[1].value,
                phoneNumber: document.querySelector('input[type="tel"]').value,
                email: document.querySelector('input[type="email"]').value,
                
                contactMethods: Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.nextElementSibling.textContent),
                
                listingId: 'VH-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                status: 'active',
                location: 'Sri Lanka',
                createdAt: window.serverTimestamp(),
                updatedAt: window.serverTimestamp()
            };
        }

        // Navigation functions
        function showStep(step) {
            console.log('Showing step:', step);
            
            steps.forEach(s => s.classList.remove('active'));
            
            const targetStep = document.querySelector(`[data-step="${step}"]`);
            if (targetStep) {
                targetStep.classList.add('active');
                console.log('Step', step, 'is now active');
            } else {
                console.error('Step element not found for step:', step);
            }
            
            stepIndicators.forEach((indicator, index) => {
                indicator.classList.remove('step-active', 'step-completed', 'step-default');
                if (index + 1 < step) {
                    indicator.classList.add('step-completed');
                } else if (index + 1 === step) {
                    indicator.classList.add('step-active');
                } else {
                    indicator.classList.add('step-default');
                }
            });
            
            progressBar.style.width = `${(step / totalSteps) * 100}%`;
            
            prevBtn.style.display = step === 1 ? 'none' : 'block';
            nextBtn.style.display = step === totalSteps ? 'none' : 'block';
            submitBtn.style.display = step === totalSteps ? 'block' : 'none';
        }

        function nextStep() {
            const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        field.style.borderColor = '';
                    }, 3000);
                } else {
                    field.style.borderColor = '';
                }
            });
            
            if (currentStep === 2) {
                const conditionSelected = document.querySelector('input[name="condition"]:checked');
                if (!conditionSelected) {
                    isValid = false;
                    document.querySelectorAll('.condition-card').forEach(card => {
                        card.style.borderColor = '#ef4444';
                    });
                    setTimeout(() => {
                        document.querySelectorAll('.condition-card').forEach(card => {
                            card.style.borderColor = '';
                        });
                    }, 3000);
                }
            }
            
            if (isValid && currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            } else if (!isValid) {
                alert('Please fill in all required fields before proceeding.');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        // Event listeners
        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Next button clicked, current step:', currentStep);
            nextStep();
        });

        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Previous button clicked, current step:', currentStep);
            prevStep();
        });

        // Enhanced form submission with Firebase integration
        document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submission started...');
            
            if (!window.db) {
                alert('Firebase is not initialized. Please refresh the page and try again.');
                return;
            }
            
            if (!window.getCurrentUser()) {
                alert('You must be logged in to list a vehicle. Please log in and try again.');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
            `;
            submitBtn.disabled = true;
            
            try {
                console.log('Collecting form data with API integration...');
                const formData = await submitFormWithAPI();
                console.log('Form data collected:', formData);
                
                const listingId = formData.listingId;
                console.log('Using listing ID for storage:', listingId);
                
                if (!formData.make || !formData.model || !formData.year || !formData.askingPrice) {
                    throw new Error('Please fill in all required fields');
                }
                
                console.log('Starting file uploads...');
                console.log('Files to upload:', uploadedFiles);
                
                let photoURLs = [];
                if (uploadedFiles.vehiclePhotos && uploadedFiles.vehiclePhotos.length > 0) {
                    console.log(`Uploading ${uploadedFiles.vehiclePhotos.length} vehicle photos...`);
                    photoURLs = await uploadFilesToStorage(uploadedFiles.vehiclePhotos, 'photos', listingId);
                    console.log('Photo URLs:', photoURLs);
                }
                
                const documentURLs = {};
                if (uploadedFiles.documents.title) {
                    console.log('Uploading title document...');
                    const titleURL = await uploadFilesToStorage([uploadedFiles.documents.title], 'documents', listingId);
                    documentURLs.title = titleURL[0];
                }
                if (uploadedFiles.documents.registration) {
                    console.log('Uploading registration document...');
                    const regURL = await uploadFilesToStorage([uploadedFiles.documents.registration], 'documents', listingId);
                    documentURLs.registration = regURL[0];
                }
                
                console.log('Document URLs:', documentURLs);
                
                formData.photos = photoURLs.filter(url => url !== null);
                formData.documents = documentURLs;
                
                const aiEstimateElement = document.getElementById('aiEstimate');
                if (!formData.aiEstimate && aiEstimateElement) {
                    formData.aiEstimate = aiEstimateElement.textContent || 'Not calculated';
                }
                
                formData.createdAt = window.serverTimestamp();
                formData.updatedAt = window.serverTimestamp();
                formData.status = 'active';
                
                console.log('Final form data to save:', formData);
                
                console.log('Saving to Firestore Advertisements collection...');
                const docRef = await window.addDoc(window.collection(window.db, 'Advertisements'), formData);
                
                console.log('‚úÖ Advertisement saved successfully! Document ID:', docRef.id);
                
                const apiInfo = formData.aiPrediction ? 
                    `<p class="text-green-600 text-sm">‚úÖ Enhanced AI prediction applied</p>` :
                    `<p class="text-orange-600 text-sm">‚ö†Ô∏è Do your own market research </p>`;
                
                const voiceInfo = formData.additionalNotes ? 
                    `<p class="text-blue-600 text-sm">üé§ Voice notes included in listing</p>` :
                    `<p class="text-gray-600 text-sm">üìù Manual text input used</p>`;
                
                const container = document.querySelector('.glass-effect');
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="text-6xl mb-6">üéâ</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Vehicle Listed Successfully!</h2>
                        <p class="text-gray-600 mb-6">Your vehicle has been saved to the database and is now available for buyers.</p>
                        ${apiInfo}
                        ${voiceInfo}
                        <div class="space-y-4 mt-6">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <p class="text-gray-800 font-medium">Listing ID: ${formData.listingId}</p>
                                <p class="text-gray-600 text-sm">Database ID: ${docRef.id}</p>
                                <p class="text-gray-600 text-sm">AI Estimate: ${formData.aiEstimate || 'Not calculated'}</p>
                                <p class="text-gray-600 text-sm">Collection: Advertisements</p>
                                <p class="text-gray-600 text-sm">Listed by: ${formData.userName || formData.userEmail}</p>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-medium text-green-800 mb-2">‚úÖ Features Used:</h4>
                                <ul class="text-green-700 text-sm space-y-1 text-left">
                                    <li>‚Ä¢ ${formData.additionalNotes ? 'üé§ Voice notes captured' : 'üìù Manual text input'}</li>
                                    <li>‚Ä¢ ü§ñ AI price estimation</li>
                                    <li>‚Ä¢ üìä Market analysis</li>
                                    <li>‚Ä¢ üîí Secure Firebase storage</li>
                                    <li>‚Ä¢ üì∏ Photo uploads</li>
                                </ul>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-medium text-blue-800 mb-2">üìà Market Information</h4>
                                <p class="text-blue-700 text-sm">
                                    ${formData.vehicleValidation?.valid ? 
                                        `Vehicle found in database: ${formData.vehicleValidation.vehicle_data?.market_status || 'Available'}` :
                                        'Vehicle estimated using general market data'
                                    }
                                </p>
                            </div>
                            <div class="flex space-x-4 justify-center">
                                <button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition-colors" onclick="window.location.href='dashboard.html'">
                                    üè† Return to Dashboard
                                </button>
                                <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors" onclick="window.location.reload()">
                                    ‚ûï List Another Vehicle
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error saving advertisement:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                alert(`Error saving your listing: ${error.message}\n\nPlease check the browser console for more details and try again.`);
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Voice-to-Text
            window.voiceToText = new VoiceToText();
            
            // Add clear button functionality with enhanced debugging
            const clearTextButton = document.getElementById('clearTextButton');
            if (clearTextButton) {
                clearTextButton.addEventListener('click', () => {
                    console.log('üßπ Clear button clicked');
                    if (window.voiceToText) {
                        window.voiceToText.clearRepetitiveText();
                    }
                });
            }
            
            // Add test button for debugging (temporary)
            const testButton = document.createElement('button');
            testButton.textContent = 'üß™ Test Voice';
            testButton.className = 'absolute right-28 bottom-3 bg-blue-500 hover:bg-blue-600 border-none rounded px-3 py-1 cursor-pointer text-white text-xs';
            testButton.title = 'Test voice input functionality';
            testButton.addEventListener('click', () => {
                if (window.voiceToText) {
                    console.log('üß™ Running voice test...');
                    window.voiceToText.testTextareaUpdate();
                    // Test adding a sentence directly
                    setTimeout(() => {
                        window.voiceToText.addSentenceToTextarea('This is a test sentence from the test button');
                    }, 1000);
                }
            });
            
            // Add test button to the voice container
            const voiceContainer = document.querySelector('.voice-input-container');
            if (voiceContainer) {
                voiceContainer.appendChild(testButton);
            }
            
            // Initialize chatbot
            window.enhancedWheelzAIChatbot = new EnhancedWheelzAIChatbot();
            
            // Populate year dropdown with dynamic years
            populateYearDropdown();
            
            // Set initial AI estimate
            const aiEstimateElement = document.getElementById('aiEstimate');
            if (aiEstimateElement) {
                aiEstimateElement.innerHTML = 'Enter vehicle details for AI estimate';
            }
            
            showStep(1);
            
            // Test API connection on page load
            setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/health`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ API connected:', data.message);
                        
                        const aiEstimateElement = document.getElementById('aiEstimate');
                        if (aiEstimateElement && aiEstimateElement.textContent.includes('Enter vehicle details')) {
                            aiEstimateElement.innerHTML = 'Enter vehicle details for enhanced AI estimate';
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è API not available, using basic calculations:', error.message);
                    
                    const aiEstimateElement = document.getElementById('aiEstimate');
                    if (aiEstimateElement && aiEstimateElement.textContent.includes('Enter vehicle details')) {
                        aiEstimateElement.innerHTML = 'Enter vehicle details for basic estimate (API offline)';
                    }
                }
            }, 1000);
            
            console.log('‚úÖ Enhanced Voice-to-Text initialized with improved accuracy');
            console.log('üé§ Features: Text cleaning, auto-correction, repetition filtering');
            console.log('üåê Languages: English, Sinhala (si-LK), Tamil (ta-LK)');
        });
    </script>
</body>
</html>