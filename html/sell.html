<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Your Vehicle - WheelzAI</title>
    <script src="/Wheelz_AI/Javascript/price_predictor_client.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOamMqCPIzJurf85fjBleVmWffdscEslM",
            authDomain: "wheelzai.firebaseapp.com",
            projectId: "wheelzai",
            storageBucket: "wheelzai.firebasestorage.app",
            messagingSenderId: "132756052907",
            appId: "1:132756052907:web:b92dc998b4b5bee8d450ee",
            measurementId: "G-ECQJYZYK43"
        };

        // Initialize Firebase
        console.log('Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        console.log('Firebase initialized successfully');

        // Make Firebase functions globally available
        window.db = db;
        window.storage = storage;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.signOut = signOut;
        
        // Session Management
        let currentUser = null;
        let isPageReady = false;
        
        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ User is authenticated:', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName
                });
                
                // Store session info
                sessionStorage.setItem('wheelzai_user', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                }));
                
                // Show the page content
                showPageContent();
                
                // Update UI with user info
                updateUserInterface(user);
                
            } else {
                console.log('‚ùå User is not authenticated');
                currentUser = null;
                
                // Clear session
                sessionStorage.removeItem('wheelzai_user');
                
                // Show authentication required message
                showAuthRequired();
            }
        });
        
        // Function to show page content (when authenticated)
        function showPageContent() {
            if (isPageReady) return;
            isPageReady = true;
            
            const loadingElement = document.getElementById('loading');
            const contentElement = document.getElementById('content');
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (contentElement) contentElement.style.display = 'block';
        }
        
        // Function to show authentication required
        function showAuthRequired() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-6xl mb-4">üîí</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Authentication Required</h2>
                        <p class="text-gray-600 mb-4">Please log in to access the vehicle listing page</p>
                        <div class="space-y-3">
                            <button onclick="window.location.href='index.html'" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                Go to Login
                            </button>
                            <p class="text-sm text-gray-500">Redirecting in <span id="countdown">3</span> seconds...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Countdown and redirect
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            const interval = setInterval(() => {
                countdown--;
                if (countdownElement) countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    window.location.href = 'index.html';
                }
            }, 1000);
        }
        
        // Function to update UI with user information
        function updateUserInterface(user) {
            setTimeout(() => {
                const userInfoElement = document.getElementById('userInfo');
                if (userInfoElement) {
                    userInfoElement.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                ${user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase()}
                            </div>
                            <span class="text-gray-700">${user.displayName || user.email}</span>
                        </div>
                    `;
                    userInfoElement.classList.remove('hidden');
                }
            }, 500);
        }
        
        // Global logout function
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error signing out. Please try again.');
            }
        };
        
        // Function to get current user
        window.getCurrentUser = function() {
            return currentUser;
        };
        
        // Test functions
        window.testFirebaseConnection = async function() {
            try {
                const testDoc = {
                    test: true,
                    timestamp: serverTimestamp(),
                    userId: currentUser?.uid || 'anonymous'
                };
                const docRef = await addDoc(collection(db, 'test'), testDoc);
                alert('Firebase connection successful! Test document ID: ' + docRef.id);
                return true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                alert('Firebase connection failed: ' + error.message);
                return false;
            }
        };
        
        console.log('Firebase setup complete with session management.');
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }
        
        .step-completed {
            background: #10b981;
            color: white;
        }
        
        .step-default {
            background: #e2e8f0;
            color: #64748b;
        }
        
        .form-step {
            display: none;
            animation: fadeInUp 0.5s ease;
        }
        
        .form-step.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8faff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #e0e7ff;
        }
        
        .floating-label {
            transform: translateY(0.5rem);
            transition: all 0.2s ease;
            color: #64748b;
        }
        
        .floating-label.active {
            transform: translateY(-1.25rem);
            font-size: 0.75rem;
            color: #667eea;
        }
        
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            background-color: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .custom-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .custom-select option {
            background: white;
            color: #374151;
            padding: 0.5rem;
        }
        
        .form-input {
            background-color: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input::placeholder {
            color: #9ca3af;
        }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        #content {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Loading State -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading...</p>
        </div>
    </div>
    
    <!-- Main Content (Hidden until authenticated) -->
    <div id="content">
        <div class="container mx-auto px-4 py-8">
            <!-- Header with Navigation -->
            <div class="flex justify-between items-center mb-8">
                <div class="text-center flex-1">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Sell Your Vehicle</h1>
                    <p class="text-gray-600">Get the best price for your vehicle with our AI-powered valuation</p>
                </div>
                
                <!-- User Info & Navigation -->
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            üè† Dashboard
                        </button>
                        <button onclick="handleLogout()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="progressBar" class="progress-bar h-full bg-gradient-to-r from-purple-500 to-blue-500 rounded-full" style="width: 25%"></div>
                </div>
            </div>

            <!-- Step Indicators -->
            <div class="flex justify-center mb-8">
                <div class="flex space-x-4">
                    <div class="step-indicator step-active w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                    <div class="step-indicator step-default w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                    <div class="step-indicator step-default w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                    <div class="step-indicator step-default w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                </div>
            </div>

            <!-- Main Form Container -->
            <div class="max-w-4xl mx-auto">
                <div class="glass-effect rounded-2xl p-8">
                    <form id="vehicleForm">
                        <!-- Step 1: Basic Information -->
                        <div class="form-step active" data-step="1">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Basic Information</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Vehicle Make</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Make</option>
                                        <option value="toyota">Toyota</option>
                                        <option value="honda">Honda</option>
                                        <option value="ford">Ford</option>
                                        <option value="chevrolet">Chevrolet</option>
                                        <option value="nissan">Nissan</option>
                                        <option value="hyundai">Hyundai</option>
                                        <option value="bmw">BMW</option>
                                        <option value="mercedes">Mercedes-Benz</option>
                                        <option value="audi">Audi</option>
                                        <option value="volkswagen">Volkswagen</option>
                                    </select>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Model</label>
                                    <input type="text" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Year</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Year</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                        <option value="2020">2020</option>
                                        <option value="2019">2019</option>
                                        <option value="2018">2018</option>
                                        <option value="2017">2017</option>
                                        <option value="2016">2016</option>
                                        <option value="2015">2015</option>
                                    </select>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Mileage</label>
                                    <input type="number" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Body Type</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Body Type</option>
                                        <option value="sedan">Sedan</option>
                                        <option value="suv">SUV</option>
                                        <option value="hatchback">Hatchback</option>
                                        <option value="coupe">Coupe</option>
                                        <option value="convertible">Convertible</option>
                                        <option value="wagon">Wagon</option>
                                        <option value="truck">Truck</option>
                                        <option value="van">Van</option>
                                    </select>
                                </div>
                                
                                <div class="relative">
                                    <label class="floating-label absolute left-3 pointer-events-none">Fuel Type</label>
                                    <select class="custom-select w-full p-4 pt-6 rounded-lg" required>
                                        <option value="">Select Fuel Type</option>
                                        <option value="gasoline">Gasoline</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="hybrid">Hybrid</option>
                                        <option value="electric">Electric</option>
                                        <option value="plugin-hybrid">Plug-in Hybrid</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Vehicle Condition -->
                        <div class="form-step" data-step="2">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Vehicle Condition</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Overall Condition</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <label class="relative cursor-pointer">
                                            <input type="radio" name="condition" value="excellent" class="sr-only">
                                            <div class="condition-card p-6 border-2 border-gray-200 rounded-lg text-center transition-all hover:border-purple-400 hover:bg-purple-50">
                                                <div class="text-3xl mb-2">‚≠ê</div>
                                                <div class="text-gray-800 font-medium">Excellent</div>
                                                <div class="text-gray-600 text-sm">Like new condition</div>
                                            </div>
                                        </label>
                                        <label class="relative cursor-pointer">
                                            <input type="radio" name="condition" value="good" class="sr-only">
                                            <div class="condition-card p-6 border-2 border-gray-200 rounded-lg text-center transition-all hover:border-purple-400 hover:bg-purple-50">
                                                <div class="text-3xl mb-2">üëç</div>
                                                <div class="text-gray-800 font-medium">Good</div>
                                                <div class="text-gray-600 text-sm">Minor wear and tear</div>
                                            </div>
                                        </label>
                                        <label class="relative cursor-pointer">
                                            <input type="radio" name="condition" value="fair" class="sr-only">
                                            <div class="condition-card p-6 border-2 border-gray-200 rounded-lg text-center transition-all hover:border-purple-400 hover:bg-purple-50">
                                                <div class="text-3xl mb-2">üîß</div>
                                                <div class="text-gray-800 font-medium">Fair</div>
                                                <div class="text-gray-600 text-sm">Needs some repairs</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="relative">
                                        <label class="floating-label active absolute left-3 pointer-events-none">Accident History</label>
                                        <select class="custom-select w-full p-4 pt-6 rounded-lg">
                                            <option value="none">No Accidents</option>
                                            <option value="minor">Minor Accidents</option>
                                            <option value="major">Major Accidents</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label active absolute left-3 pointer-events-none">Service History</label>
                                        <select class="custom-select w-full p-4 pt-6 rounded-lg">
                                            <option value="complete">Complete Service Records</option>
                                            <option value="partial">Partial Service Records</option>
                                            <option value="none">No Service Records</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Additional Notes</label>
                                    <textarea class="form-input w-full p-4 rounded-lg h-32" placeholder="Any additional information about your vehicle's condition, modifications, or special features..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Photos & Documents -->
                        <div class="form-step" data-step="3">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Photos & Documents</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Vehicle Photos</label>
                                    <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all">
                                        <div class="text-gray-500 mb-4">
                                            <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <p class="text-lg text-gray-700">Upload vehicle photos</p>
                                            <p class="text-sm text-gray-500">Drag and drop or click to browse</p>
                                            <p class="text-xs text-gray-400 mt-2">Recommended: Front, back, interior, engine bay</p>
                                        </div>
                                        <input type="file" class="hidden" multiple accept="image/*">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Documents</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer">
                                            <div class="text-gray-500">
                                                <svg class="mx-auto h-8 w-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                <p class="text-sm text-gray-700">Vehicle Title</p>
                                            </div>
                                            <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                                        </div>
                                        
                                        <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer">
                                            <div class="text-gray-500">
                                                <svg class="mx-auto h-8 w-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                <p class="text-sm text-gray-700">Registration</p>
                                            </div>
                                            <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Pricing & Contact -->
                        <div class="form-step" data-step="4">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Pricing & Contact Information</h2>
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">ü§ñ AI Estimated Value</h3>
                                    <div id="aiEstimate" class="text-3xl font-bold text-purple-600 mb-2">LKR 4.2L - 5.8L</div>
                                    <p class="text-gray-600 text-sm">Based on Sri Lankan market data, vehicle condition, and mileage</p>
                                    <div class="mt-3 text-xs text-gray-500">
                                        <span>üìä Comparable vehicles: LKR 3.8M - 6.2M</span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="relative">
                                        <label class="floating-label absolute left-3 pointer-events-none">Your Asking Price (LKR)</label>
                                        <input type="number" class="form-input w-full p-4 pt-6 rounded-lg" placeholder="4500000" required>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label active absolute left-3 pointer-events-none">Negotiable?</label>
                                        <select class="custom-select w-full p-4 pt-6 rounded-lg">
                                            <option value="yes">Yes, open to negotiation</option>
                                            <option value="no">No, firm price</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label absolute left-3 pointer-events-none">Your Name</label>
                                        <input type="text" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                    </div>
                                    
                                    <div class="relative">
                                        <label class="floating-label absolute left-3 pointer-events-none">Phone Number</label>
                                        <input type="tel" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                    </div>
                                    
                                    <div class="relative md:col-span-2">
                                        <label class="floating-label absolute left-3 pointer-events-none">Email Address</label>
                                        <input type="email" class="form-input w-full p-4 pt-6 rounded-lg" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-3 font-medium">Preferred Contact Method</label>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                                            <span class="text-gray-700">Phone</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                                            <span class="text-gray-700">Email</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                                            <span class="text-gray-700">Text Message</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between mt-8">
                            <button type="button" id="prevBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors" style="display: none;">Previous</button>
                            <button type="button" id="nextBtn" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition-colors ml-auto">Next</button>
                            <button type="submit" id="submitBtn" class="px-8 py-3 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition-colors ml-auto" style="display: none;">List Vehicle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
const totalSteps = 4;

// Elements
const steps = document.querySelectorAll('.form-step');
const stepIndicators = document.querySelectorAll('.step-indicator');
const progressBar = document.getElementById('progressBar');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');

// API Configuration
const API_BASE_URL = 'http://localhost:5000'; // Your Flask API URL

// Enhanced LKR formatting function
function formatLKR(amount) {
    if (amount >= 1000000000) {
        return `${(amount / 1000000000).toFixed(1)} Billion`;
    } else if (amount >= 10000000) {
        return `${(amount / 10000000).toFixed(1)} Crore`;
    } else if (amount >= 1000000) {
        return `${(amount / 1000000).toFixed(1)} Million`;
    } else if (amount >= 100000) {
        return `${(amount / 100000).toFixed(1)} Lakh`;
    } else {
        return amount.toLocaleString();
    }
}

// Vehicle valuation data for Sri Lankan market (in LKR) - Fallback data
const vehicleData = {
    toyota: {
        vios: { base: 4500000, yearDepreciation: 200000, mileageDepreciation: 15 },
        corolla: { base: 6500000, yearDepreciation: 300000, mileageDepreciation: 20 },
        camry: { base: 12000000, yearDepreciation: 500000, mileageDepreciation: 25 },
        prius: { base: 7500000, yearDepreciation: 350000, mileageDepreciation: 18 },
        aqua: { base: 8000000, yearDepreciation: 300000, mileageDepreciation: 16 }
    },
    honda: {
        civic: { base: 8500000, yearDepreciation: 400000, mileageDepreciation: 22 },
        fit: { base: 5500000, yearDepreciation: 250000, mileageDepreciation: 16 },
        accord: { base: 15000000, yearDepreciation: 600000, mileageDepreciation: 28 },
        city: { base: 6000000, yearDepreciation: 280000, mileageDepreciation: 18 },
        grace: { base: 6200000, yearDepreciation: 270000, mileageDepreciation: 17 }
    },
    nissan: {
        march: { base: 4200000, yearDepreciation: 180000, mileageDepreciation: 14 },
        sunny: { base: 5800000, yearDepreciation: 260000, mileageDepreciation: 17 },
        teana: { base: 8500000, yearDepreciation: 400000, mileageDepreciation: 24 },
        leaf: { base: 7200000, yearDepreciation: 300000, mileageDepreciation: 15 }
    },
    suzuki: {
        swift: { base: 4800000, yearDepreciation: 200000, mileageDepreciation: 15 },
        wagon_r: { base: 3800000, yearDepreciation: 170000, mileageDepreciation: 13 },
        alto: { base: 3200000, yearDepreciation: 150000, mileageDepreciation: 12 }
    },
    bmw: {
        "3series": { base: 18000000, yearDepreciation: 800000, mileageDepreciation: 35 },
        "5series": { base: 25000000, yearDepreciation: 1200000, mileageDepreciation: 45 }
    },
    mercedes: {
        "c-class": { base: 20000000, yearDepreciation: 900000, mileageDepreciation: 38 },
        "e-class": { base: 30000000, yearDepreciation: 1400000, mileageDepreciation: 50 }
    }
};

// Function to populate year dropdown dynamically
function populateYearDropdown() {
    const yearSelect = document.querySelectorAll('select[required]')[1]; // Year dropdown (second required select)
    
    if (yearSelect && yearSelect.querySelector('option[value=""]')) {
        // Clear existing options except the placeholder
        const placeholder = yearSelect.querySelector('option[value=""]');
        yearSelect.innerHTML = '';
        yearSelect.appendChild(placeholder);
        
        // Generate years from 1990 to current year + 1 (2025)
        const currentYear = new Date().getFullYear();
        const startYear = 1990;
        const endYear = Math.max(currentYear + 1, 2025); // Ensure it goes at least to 2025
        
        // Add years in descending order (newest first)
        for (let year = endYear; year >= startYear; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
        
        console.log(`Year dropdown populated with years ${startYear}-${endYear}`);
    }
}

// Enhanced AI estimate calculation using API
async function calculateAIEstimate() {
    const makeSelect = document.querySelector('select[required]');
    const modelInput = document.querySelector('input[required]');
    const yearSelect = document.querySelectorAll('select[required]')[1];
    const mileageInput = document.querySelector('input[type="number"]');
    const bodyTypeSelect = document.querySelectorAll('select[required]')[2];
    const fuelTypeSelect = document.querySelectorAll('select[required]')[3];
    
    // Check if all required fields are filled
    if (!makeSelect.value || !modelInput.value || !yearSelect.value || 
        !mileageInput.value || !bodyTypeSelect.value || !fuelTypeSelect.value) {
        return;
    }
    
    const aiEstimateElement = document.getElementById('aiEstimate');
    const confidenceElement = document.querySelector('.text-gray-600.text-sm');
    const comparableElement = document.querySelector('.text-xs.text-gray-500 span');
    
    // Show loading state
    if (aiEstimateElement) {
        aiEstimateElement.innerHTML = `
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                <span>Calculating...</span>
            </div>
        `;
    }
    
    try {
        // Get condition if selected
        const selectedCondition = document.querySelector('input[name="condition"]:checked');
        const condition = selectedCondition ? selectedCondition.value : 'good';
        
        // Prepare API request data
        const requestData = {
            make: makeSelect.value,
            model: modelInput.value,
            year: parseInt(yearSelect.value),
            mileage: parseInt(mileageInput.value),
            fuel_type: fuelTypeSelect.value,
            body_type: bodyTypeSelect.value,
            condition: condition,
            engine_size: 1500, // Default
            transmission: 'automatic' // Default
        };
        
        console.log('Sending API request:', requestData);
        
        // Call the enhanced API
        const response = await fetch(`${API_BASE_URL}/predict-price`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('API response:', data);
        
        if (data.success && data.prediction) {
            const prediction = data.prediction;
            const marketAnalysis = data.market_analysis;
            
            // Update AI estimate display with enhanced formatting
            const lowerBound = prediction.price_range.lower;
            const upperBound = prediction.price_range.upper;
            
            if (aiEstimateElement) {
                aiEstimateElement.innerHTML = `LKR ${formatLKR(lowerBound)} - ${formatLKR(upperBound)}`;
            }
            
            // Update confidence and market info
            if (confidenceElement) {
                confidenceElement.innerHTML = `
                    Based on Sri Lankan market data, vehicle condition, and mileage
                    <br><strong>Confidence:</strong> ${prediction.confidence_level || 'High'}
                    ${marketAnalysis.market_data_available ? 
                        `<br><strong>Market Status:</strong> ${marketAnalysis.demand_status || 'Market data available'}` : 
                        '<br><strong>Market Status:</strong> General market estimation'
                    }
                `;
            }
            
            // Update comparable vehicles info
            if (comparableElement && marketAnalysis.market_data_available) {
                const basePrice = marketAnalysis.current_market_value;
                if (basePrice) {
                    const basePriceFormatted = basePrice.replace(/LKR\s/, '');
                    comparableElement.innerHTML = `üìä Market base value: ${basePriceFormatted} | Trend: ${marketAnalysis.market_trend || 'Stable'}`;
                }
            }
            
            // Add detailed breakdown (optional enhancement)
            addPredictionBreakdown(data);
            
        } else {
            throw new Error(data.message || 'Failed to get price prediction');
        }
        
    } catch (error) {
        console.error('API request failed:', error);
        
        // Fallback to basic calculation
        calculateBasicEstimate();
        
        // Show error info
        if (confidenceElement) {
            confidenceElement.innerHTML = `
                Using basic market calculation (API unavailable)
                <br><small class="text-orange-600">For accurate pricing, please ensure API is running</small>
            `;
        }
    }
}

// Fallback basic calculation (enhanced version of your original logic)
function calculateBasicEstimate() {
    const makeSelect = document.querySelector('select[required]');
    const modelInput = document.querySelector('input[required]');
    const yearSelect = document.querySelectorAll('select[required]')[1];
    const mileageInput = document.querySelector('input[type="number"]');
    
    if (!makeSelect.value || !modelInput.value || !yearSelect.value || !mileageInput.value) {
        return;
    }
    
    const make = makeSelect.value.toLowerCase();
    const model = modelInput.value.toLowerCase().replace(/\s+/g, '').replace('-', '');
    const year = parseInt(yearSelect.value);
    const mileage = parseInt(mileageInput.value);
    const currentYear = new Date().getFullYear();
    
    // Get condition multiplier
    let conditionMultiplier = 1.0;
    const selectedCondition = document.querySelector('input[name="condition"]:checked');
    if (selectedCondition) {
        switch(selectedCondition.value) {
            case 'excellent': conditionMultiplier = 1.15; break;
            case 'good': conditionMultiplier = 1.0; break;
            case 'fair': conditionMultiplier = 0.85; break;
        }
    }
    
    // Default values for unknown makes/models
    let basePrice = 5000000;
    let yearDepreciation = 250000;
    let mileageDepreciation = 20;
    
    // Try to find specific vehicle data
    if (vehicleData[make]) {
        // Try exact model match first
        const exactMatch = Object.keys(vehicleData[make]).find(key => 
            model.includes(key) || key.includes(model)
        );
        
        if (exactMatch) {
            const vehicleInfo = vehicleData[make][exactMatch];
            basePrice = vehicleInfo.base;
            yearDepreciation = vehicleInfo.yearDepreciation;
            mileageDepreciation = vehicleInfo.mileageDepreciation;
        } else {
            // Use average for the make
            const makeModels = Object.values(vehicleData[make]);
            basePrice = makeModels.reduce((sum, model) => sum + model.base, 0) / makeModels.length;
            yearDepreciation = makeModels.reduce((sum, model) => sum + model.yearDepreciation, 0) / makeModels.length;
            mileageDepreciation = makeModels.reduce((sum, model) => sum + model.mileageDepreciation, 0) / makeModels.length;
        }
    }
    
    // Calculate depreciation (modified for Sri Lankan market - less depreciation)
    const ageDepreciation = (currentYear - year) * yearDepreciation * 0.8; // Reduced depreciation
    const mileageDepreciationAmount = (mileage / 1000) * mileageDepreciation * 0.7; // Reduced mileage impact
    
    // Calculate estimated value
    let estimatedValue = basePrice - ageDepreciation - mileageDepreciationAmount;
    estimatedValue *= conditionMultiplier;
    
    // Ensure minimum value
    estimatedValue = Math.max(estimatedValue, 1000000);
    
    // Create range (¬±15%)
    const lowerBound = Math.round(estimatedValue * 0.85);
    const upperBound = Math.round(estimatedValue * 1.15);
    
    // Update the display with enhanced formatting
    const aiEstimateElement = document.getElementById('aiEstimate');
    if (aiEstimateElement) {
        aiEstimateElement.innerHTML = `LKR ${formatLKR(lowerBound)} - ${formatLKR(upperBound)}`;
    }
}

// Add detailed prediction breakdown
function addPredictionBreakdown(apiData) {
    const breakdown = apiData.prediction.individual_predictions;
    if (!breakdown) return;
    
    const aiEstimateContainer = document.querySelector('.bg-gradient-to-r.from-purple-50.to-blue-50');
    if (!aiEstimateContainer) return;
    
    // Check if breakdown already exists
    if (aiEstimateContainer.querySelector('.prediction-breakdown')) return;
    
    const breakdownHtml = `
        <div class="prediction-breakdown mt-4 p-3 bg-white bg-opacity-50 rounded-lg border border-purple-200">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">üîç AI Model Breakdown:</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
                ${Object.entries(breakdown).map(([model, price]) => 
                    `<div class="flex justify-between">
                        <span class="text-gray-600">${model.toUpperCase()}:</span>
                        <span class="font-medium">${price}</span>
                    </div>`
                ).join('')}
            </div>
            <div class="mt-2 text-xs text-gray-500">
                Final estimate uses weighted ensemble of multiple ML models
            </div>
        </div>
    `;
    
    aiEstimateContainer.insertAdjacentHTML('beforeend', breakdownHtml);
}

// Enhanced form submission with API validation
async function submitFormWithAPI() {
    const formData = collectFormData();
    
    try {
        // Validate vehicle with API first
        const validationResponse = await fetch(`${API_BASE_URL}/validate-vehicle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                make: formData.make,
                model: formData.model
            })
        });
        
        if (validationResponse.ok) {
            const validationData = await validationResponse.json();
            console.log('Vehicle validation:', validationData);
            
            // Add validation info to form data
            formData.vehicleValidation = validationData;
        }
        
        // Get final price prediction
        const finalPrediction = await fetch(`${API_BASE_URL}/predict-price`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                make: formData.make,
                model: formData.model,
                year: formData.year,
                mileage: formData.mileage,
                fuel_type: formData.fuelType,
                body_type: formData.bodyType,
                condition: formData.condition,
                transmission: 'automatic',
                accident_history: formData.accidentHistory || 'none',
                service_records: formData.serviceHistory || 'complete'
            })
        });
        
        if (finalPrediction.ok) {
            const predictionData = await finalPrediction.json();
            formData.aiPrediction = predictionData;
            formData.aiEstimate = `LKR ${formatLKR(predictionData.prediction.price_range.lower)} - ${formatLKR(predictionData.prediction.price_range.upper)}`;
        }
        
    } catch (error) {
        console.warn('API validation/prediction failed, proceeding with basic data:', error);
    }
    
    return formData;
}

// Floating label functionality
document.querySelectorAll('input, select, textarea').forEach(element => {
    const label = element.parentElement.querySelector('.floating-label');
    
    if (label) {
        function updateLabel() {
            if (element.value || element.tagName === 'SELECT') {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        }
        
        element.addEventListener('focus', () => label.classList.add('active'));
        element.addEventListener('blur', updateLabel);
        element.addEventListener('input', () => {
            updateLabel();
            // Recalculate AI estimate when key fields change
            if (element.required || element.name === 'condition' || element.type === 'number') {
                setTimeout(calculateAIEstimate, 500); // Increased delay to avoid too many API calls
            }
        });
        
        // Initial check
        updateLabel();
    }
});

// Condition selection
document.querySelectorAll('input[name="condition"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.condition-card').forEach(card => {
            card.classList.remove('bg-purple-100', 'border-purple-400', 'text-purple-800');
            card.classList.add('text-gray-800', 'border-gray-200');
        });
        
        if (this.checked) {
            const card = this.parentElement.querySelector('.condition-card');
            card.classList.remove('text-gray-800', 'border-gray-200');
            card.classList.add('bg-purple-100', 'border-purple-400', 'text-purple-800');
            
            // Recalculate AI estimate when condition changes
            setTimeout(calculateAIEstimate, 300);
        }
    });
});

// File upload functionality with Firebase Storage
let uploadedFiles = {
    vehiclePhotos: [],
    documents: {
        title: null,
        registration: null
    }
};

document.querySelectorAll('.upload-area').forEach(area => {
    const input = area.querySelector('input[type="file"]');
    
    if (input) {
        area.addEventListener('click', () => input.click());
        
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            input.files = e.dataTransfer.files;
            handleFileSelection(area, input.files, input);
        });
        
        input.addEventListener('change', () => {
            handleFileSelection(area, input.files, input);
        });
    }
});

function handleFileSelection(area, files, inputElement) {
    if (files.length > 0) {
        const fileList = Array.from(files).map(file => file.name).join(', ');
        const multiple = inputElement && inputElement.multiple;
        const accept = inputElement && inputElement.accept;
        
        // Store files for later upload
        if (multiple) {
            // Vehicle photos
            uploadedFiles.vehiclePhotos = Array.from(files);
        } else {
            // Documents
            const docType = area.closest('.grid') ? 
                (area === area.closest('.grid').children[0] ? 'title' : 'registration') : 'title';
            uploadedFiles.documents[docType] = files[0];
        }
        
        area.innerHTML = `
            <div class="text-gray-700">
                <svg class="mx-auto h-8 w-8 mb-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <p class="text-sm font-medium">${files.length} file(s) selected</p>
                <p class="text-xs text-gray-500">${fileList}</p>
            </div>
            <input type="file" class="hidden" ${multiple ? 'multiple' : ''} accept="${accept || ''}">
        `;
    }
}

// Function to upload files to Firebase Storage
async function uploadFilesToStorage(files, folder, listingId) {
    console.log(`üîÑ Starting upload for ${files.length} files to folder: ${folder}, listingId: ${listingId}`);
    
    const uploadPromises = files.map(async (file, index) => {
        if (!file) {
            console.log(`‚ö†Ô∏è File ${index} is null, skipping...`);
            return null;
        }
        
        const timestamp = Date.now();
        const fileExtension = file.name.split('.').pop();
        const fileName = `vehicles/${listingId}/${folder}/${timestamp}_${index}.${fileExtension}`;
        
        console.log(`üìÅ Uploading file: ${file.name}`);
        console.log(`üìç Storage path: ${fileName}`);
        console.log(`üìä File size: ${file.size} bytes`);
        console.log(`üîß File type: ${file.type}`);
        
        const storageRef = window.ref(window.storage, fileName);
        
        try {
            console.log(`‚¨ÜÔ∏è Starting upload for ${file.name}...`);
            const snapshot = await window.uploadBytes(storageRef, file);
            console.log(`‚úÖ Upload completed for ${file.name}`);
            console.log(`üì¶ Snapshot:`, snapshot);
            
            const downloadURL = await window.getDownloadURL(snapshot.ref);
            console.log(`üîó Download URL: ${downloadURL}`);
            
            return downloadURL;
        } catch (error) {
            console.error(`‚ùå Upload failed for ${file.name}:`, error);
            console.error(`üîç Error details:`, {
                code: error.code,
                message: error.message,
                serverResponse: error.serverResponse
            });
            return null;
        }
    });
    
    const results = await Promise.all(uploadPromises);
    console.log(`üéØ Upload results:`, results);
    return results;
}

// Enhanced form data collection
function collectFormData() {
    const currentUser = window.getCurrentUser();
    
    return {
        // User Information
        userId: currentUser?.uid || null,
        userEmail: currentUser?.email || null,
        userName: currentUser?.displayName || null,
        
        // Basic Information
        make: document.querySelector('select[required]').value,
        model: document.querySelector('input[required]').value,
        year: parseInt(document.querySelectorAll('select[required]')[1].value),
        mileage: parseInt(document.querySelector('input[type="number"]').value),
        bodyType: document.querySelectorAll('select[required]')[2].value,
        fuelType: document.querySelectorAll('select[required]')[3].value,
        
        // Vehicle Condition
        condition: document.querySelector('input[name="condition"]:checked')?.value || '',
        accidentHistory: document.querySelectorAll('select')[4].value,
        serviceHistory: document.querySelectorAll('select')[5].value,
        additionalNotes: document.querySelector('textarea').value,
        
        // Pricing & Contact
        askingPrice: parseInt(document.querySelector('input[placeholder="4500000"]').value),
        negotiable: document.querySelectorAll('select')[6].value === 'yes',
        sellerName: document.querySelectorAll('input[required]')[1].value,
        phoneNumber: document.querySelector('input[type="tel"]').value,
        email: document.querySelector('input[type="email"]').value,
        
        // Contact preferences
        contactMethods: Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.nextElementSibling.textContent),
        
        // Metadata
        listingId: 'VH-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
        status: 'active',
        location: 'Sri Lanka',
        createdAt: window.serverTimestamp(),
        updatedAt: window.serverTimestamp()
    };
}

// Navigation functions
function showStep(step) {
    console.log('Showing step:', step);
    
    // Hide all steps
    steps.forEach(s => s.classList.remove('active'));
    
    // Show current step
    const targetStep = document.querySelector(`[data-step="${step}"]`);
    if (targetStep) {
        targetStep.classList.add('active');
        console.log('Step', step, 'is now active');
    } else {
        console.error('Step element not found for step:', step);
    }
    
    // Update step indicators
    stepIndicators.forEach((indicator, index) => {
        indicator.classList.remove('step-active', 'step-completed', 'step-default');
        if (index + 1 < step) {
            indicator.classList.add('step-completed');
        } else if (index + 1 === step) {
            indicator.classList.add('step-active');
        } else {
            indicator.classList.add('step-default');
        }
    });
    
    // Update progress bar
    progressBar.style.width = `${(step / totalSteps) * 100}%`;
    
    // Update navigation buttons
    prevBtn.style.display = step === 1 ? 'none' : 'block';
    nextBtn.style.display = step === totalSteps ? 'none' : 'block';
    submitBtn.style.display = step === totalSteps ? 'block' : 'none';
}

function nextStep() {
    // Basic validation for current step
    const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    let isValid = true;
    
    // Check if all required fields are filled
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.style.borderColor = '#ef4444';
            // Reset border color after 3 seconds
            setTimeout(() => {
                field.style.borderColor = '';
            }, 3000);
        } else {
            field.style.borderColor = '';
        }
    });
    
    // For step 2, check if condition is selected
    if (currentStep === 2) {
        const conditionSelected = document.querySelector('input[name="condition"]:checked');
        if (!conditionSelected) {
            isValid = false;
            // Highlight condition cards
            document.querySelectorAll('.condition-card').forEach(card => {
                card.style.borderColor = '#ef4444';
            });
            setTimeout(() => {
                document.querySelectorAll('.condition-card').forEach(card => {
                    card.style.borderColor = '';
                });
            }, 3000);
        }
    }
    
    if (isValid && currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
    } else if (!isValid) {
        // Show validation message
        alert('Please fill in all required fields before proceeding.');
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

// Event listeners
nextBtn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('Next button clicked, current step:', currentStep);
    nextStep();
});

prevBtn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('Previous button clicked, current step:', currentStep);
    prevStep();
});

// Enhanced form submission with Firebase integration
document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Form submission started...');
    
    // Check if Firebase is ready
    if (!window.db) {
        alert('Firebase is not initialized. Please refresh the page and try again.');
        return;
    }
    
    // Check if user is authenticated
    if (!window.getCurrentUser()) {
        alert('You must be logged in to list a vehicle. Please log in and try again.');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
    `;
    submitBtn.disabled = true;
    
    try {
        // Collect form data with API integration
        console.log('Collecting form data with API integration...');
        const formData = await submitFormWithAPI();
        console.log('Form data collected:', formData);
        
        // Generate unique listing ID first (needed for storage path)
        const listingId = formData.listingId;
        console.log('Using listing ID for storage:', listingId);
        
        // Validate required fields
        if (!formData.make || !formData.model || !formData.year || !formData.askingPrice) {
            throw new Error('Please fill in all required fields');
        }
        
        // Upload files to Firebase Storage under vehicles/{listingId}/
        console.log('Starting file uploads...');
        console.log('Files to upload:', uploadedFiles);
        
        // Upload vehicle photos to vehicles/{listingId}/photos/
        let photoURLs = [];
        if (uploadedFiles.vehiclePhotos && uploadedFiles.vehiclePhotos.length > 0) {
            console.log(`Uploading ${uploadedFiles.vehiclePhotos.length} vehicle photos...`);
            photoURLs = await uploadFilesToStorage(uploadedFiles.vehiclePhotos, 'photos', listingId);
            console.log('Photo URLs:', photoURLs);
        }
        
        // Upload documents to vehicles/{listingId}/documents/
        const documentURLs = {};
        if (uploadedFiles.documents.title) {
            console.log('Uploading title document...');
            const titleURL = await uploadFilesToStorage([uploadedFiles.documents.title], 'documents', listingId);
            documentURLs.title = titleURL[0];
        }
        if (uploadedFiles.documents.registration) {
            console.log('Uploading registration document...');
            const regURL = await uploadFilesToStorage([uploadedFiles.documents.registration], 'documents', listingId);
            documentURLs.registration = regURL[0];
        }
        
        console.log('Document URLs:', documentURLs);
        
        // Add file URLs to form data
        formData.photos = photoURLs.filter(url => url !== null);
        formData.documents = documentURLs;
        
        // Calculate AI estimate for storage
        const aiEstimateElement = document.getElementById('aiEstimate');
        if (!formData.aiEstimate && aiEstimateElement) {
            formData.aiEstimate = aiEstimateElement.textContent || 'Not calculated';
        }
        
        // Add additional metadata
        formData.createdAt = window.serverTimestamp();
        formData.updatedAt = window.serverTimestamp();
        formData.status = 'active';
        
        console.log('Final form data to save:', formData);
        
        // Save to Firestore - Create Advertisements collection
        console.log('Saving to Firestore Advertisements collection...');
        const docRef = await window.addDoc(window.collection(window.db, 'Advertisements'), formData);
        
        console.log('‚úÖ Advertisement saved successfully! Document ID:', docRef.id);
        
        // Enhanced success message with API data
        const apiInfo = formData.aiPrediction ? 
            `<p class="text-green-600 text-sm">‚úÖ Enhanced AI prediction applied</p>` :
            `<p class="text-orange-600 text-sm">‚ö†Ô∏è Basic estimation used (API unavailable)</p>`;
        
        // Show success message
        const container = document.querySelector('.glass-effect');
        container.innerHTML = `
            <div class="text-center py-16">
                <div class="text-6xl mb-6">üéâ</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Vehicle Listed Successfully!</h2>
                <p class="text-gray-600 mb-6">Your vehicle has been saved to the database and is now available for buyers.</p>
                ${apiInfo}
                <div class="space-y-4 mt-6">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <p class="text-gray-800 font-medium">Listing ID: ${formData.listingId}</p>
                        <p class="text-gray-600 text-sm">Database ID: ${docRef.id}</p>
                        <p class="text-gray-600 text-sm">AI Estimate: ${formData.aiEstimate || 'Not calculated'}</p>
                        <p class="text-gray-600 text-sm">Collection: Advertisements</p>
                        <p class="text-gray-600 text-sm">Listed by: ${formData.userName || formData.userEmail}</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-800 mb-2">üìà Market Information</h4>
                        <p class="text-blue-700 text-sm">
                            ${formData.vehicleValidation?.valid ? 
                                `Vehicle found in database: ${formData.vehicleValidation.vehicle_data?.market_status || 'Available'}` :
                                'Vehicle estimated using general market data'
                            }
                        </p>
                    </div>
                    <div class="flex space-x-4 justify-center">
                        <button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition-colors" onclick="window.location.href='dashboard.html'">
                            üè† Return to Dashboard
                        </button>
                        <button class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors" onclick="window.location.reload()">
                            ‚ûï List Another Vehicle
                        </button>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error saving advertisement:', error);
        console.error('Error details:', {
            message: error.message,
            code: error.code,
            stack: error.stack
        });
        
        // Show detailed error message
        alert(`Error saving your listing: ${error.message}\n\nPlease check the browser console for more details and try again.`);
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Populate year dropdown with dynamic years
    populateYearDropdown();
    
    // Set initial AI estimate
    const aiEstimateElement = document.getElementById('aiEstimate');
    if (aiEstimateElement) {
        aiEstimateElement.innerHTML = 'Enter vehicle details for AI estimate';
    }
    
    showStep(1);
    
    // Test API connection on page load
    setTimeout(async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/health`);
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ API connected:', data.message);
                
                // Update initial estimate text to show API is available
                const aiEstimateElement = document.getElementById('aiEstimate');
                if (aiEstimateElement && aiEstimateElement.textContent.includes('Enter vehicle details')) {
                    aiEstimateElement.innerHTML = 'Enter vehicle details for enhanced AI estimate';
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è API not available, using basic calculations:', error.message);
            
            // Update initial estimate text to show API is unavailable
            const aiEstimateElement = document.getElementById('aiEstimate');
            if (aiEstimateElement && aiEstimateElement.textContent.includes('Enter vehicle details')) {
                aiEstimateElement.innerHTML = 'Enter vehicle details for basic estimate (API offline)';
            }
        }
    }, 1000);
});
    </script>
</body>
</html>